<!DOCTYPE html>
<html lang="en">
<head>
  <title>R2K2 | Packdraw Leaderboard</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Exclusive wager races on Packdraw for code R2K2!">
  <meta property="og:image" content="/assets/logo.png">
  <link rel="icon" type="image/png" href="/assets/logo.png">

  <!-- Global CSS (kept) -->
  <link rel="stylesheet" href="/css/app.css">
  <link rel="stylesheet" href="/css/lb.css">
  <link rel="stylesheet" href="/css/vendor.css">
  <link rel="stylesheet" href="/css/toast.css">
  <link rel="stylesheet" href="/css/theme.css">

  <script src="/js/countdown-roobet.js"></script>

  <style>
    .warning-message{
      width:90%;max-width:500px;margin:10px auto;background:rgba(255,0,0,.1);
      border:2px solid #ff4444;border-radius:4px;padding:15px;color:#ff4444;font-weight:700;
      text-align:center;box-sizing:border-box;
    }
    @media (max-width:768px){.warning-message{width:95%;padding:12px;font-size:14px;margin:10px auto}}

    /* ===== Totals + progress (kept, but we use 1 card) ===== */
    .r2k-totals{display:flex;justify-content:center;align-items:stretch;flex-wrap:wrap;gap:30px;margin:28px auto 10px;width:min(1080px,92%)}
    .r2k-total-card{flex:0 1 520px;background:#0b0f17;border:1px solid #0e2038;border-radius:14px;padding:18px 20px;box-shadow:0 0 18px rgba(0,153,255,.25)}
    .r2k-total-label{font-size:12px;letter-spacing:.08em;text-transform:uppercase;color:#87c8ff;opacity:.9}
    .r2k-total-value{margin-top:6px;font-weight:900;font-size:28px;line-height:1.2;color:#e9f5ff;text-shadow:0 0 10px rgba(0,153,255,.35);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    .tmr{display:flex;align-items:center;gap:10px;margin-top:12px;justify-content:center}
    .tmr-label{color:#b6d9ff;font-weight:900;letter-spacing:.06em;text-transform:uppercase;text-shadow:0 0 10px rgba(19,152,255,.45)}
    .tmr-value{color:#fff;font-weight:900;letter-spacing:.5px;font-size:18px;text-shadow:0 0 16px rgba(19,152,255,.8),0 0 25px rgba(19,152,255,.4)}
    @media (max-width:640px){.tmr-value{font-size:16px}}

    .r2k-meta{display:flex;justify-content:center;gap:10px;align-items:center;font-size:12px;color:#87c8ff;opacity:.95;margin-top:10px}
    .r2k-meta .strong{color:#e9f5ff;font-weight:900}

    .pd-actions{display:flex;justify-content:center;margin-top:14px}

    .prev-lb-btn{display:inline-flex;align-items:center;gap:8px;background:#2775ca;color:#000;padding:12px 24px;border-radius:8px;text-decoration:none;font-weight:900;border:2px solid rgba(255,255,255,.2);box-shadow:0 4px 15px rgba(39,117,202,.2);position:relative;overflow:hidden;margin:10px 10px 10px 0;transition:all .2s cubic-bezier(.4,0,.2,1)}
    .prev-lb-btn:hover{transform:translateY(-2px) scale(1.02);background:#2775ca;box-shadow:0 6px 20px rgba(39,117,202,.4);border-color:rgba(255,255,255,.4);color:#000;text-decoration:none}
    .prev-lb-btn svg{width:18px;height:18px}
    @media (max-width:768px){.prev-lb-btn{width:100%;margin-right:0;text-align:center;justify-content:center}}
  </style>
</head>

<body>
  <div id="toast"><span id="message"></span></div>

  <!-- Header (kept) -->
  <header id="r2kHeader">
    <div class="h-inner">
      <a href="/" class="brand" aria-label="R2K2 Home">
        <img src="/assets/logo.png" class="logo" alt="R2K2">
        <div class="name">R2K<span class="accent">2</span></div>
      </a>

      <nav class="nav" id="r2kNav">
        <a href="/">Home</a>
        <a href="/leaderboard/packdraw">Leaderboard</a>
        <a href="/raffle" aria-current="page">Raffle</a>
        <a href="/challenges">Challenges</a>
        <a href="/wagerbonus">Wager Bonus</a>
      </nav>

      <div class="actions">
        <a class="btn" href="#" id="joinPackdrawBtn" target="_blank" rel="noopener">Join Packdraw</a>
      </div>

      <div class="hamburger" id="hamburger" aria-label="Menu" aria-controls="r2kNav" aria-expanded="false">
        <span></span><span></span><span></span>
      </div>
    </div>
  </header>

  <!-- Background elements (kept) -->
  <canvas id="particleCanvas"></canvas>
  <div class="glow-container"><div class="left-glow"></div><div class="right-glow"></div></div>
  <object type="image/png" data="/assets/left-packdraw.png" id="leftsvg" height="100%"></object>
  <object type="image/png" data="/assets/right-packdraw.png" id="rightsvg" height="100%"></object>

  <!-- Provider image (kept) -->
  <div class="toggle-images" style="margin-top:50px;">
    <img class="game-image roobet-image" id="roobetImage" src="/assets/packdraw.png" style="cursor:pointer;opacity:1;" onclick="window.location.href='/leaderboard/packdraw'">
  </div>

  <!-- Main content (kept structure) -->
  <div data-v-1d580398 data-v-e4097664 id="appContent">
    <div data-v-1d580398>
      <div data-v-1d580398 class="row text">
        <span data-v-1d580398 class="title">
          <div data-v-1d580398 class="price-wrapper glow">$2,000</div>
          MONTHLY CODE <span class="glow">R2K2</span> Leaderboard!
        </span>

        <span data-v-1d580398 class="subtitle" style="color:#FFF;">
          Every <b>WAGER</b> on Packdraw under Code <b>R2K2</b> counts towards your score. <br>
          <i>The leaderboard updates every 15 minutes.</i><br>
          <div class="warning-message">It Only Takes One!</div>

          <!-- keep your buttons exactly (optional) -->
          <button id="rulesButton" class="prev-lb-btn" style="background:#FFFFFF;cursor:pointer;border:none;color:#000;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
            RULES
          </button>
        </span>
      </div>
    </div>

    <!-- ✅ SINGLE CARD (replaces the 2 totals + leaderboard list) -->
    <div class="r2k-totals">
      <div class="r2k-total-card">
        <div class="r2k-total-label">Total Wagered</div>
        <div class="r2k-total-value" id="pdTotal">$0</div>

        <div class="tmr">
          <span class="tmr-label">ENDING IN</span>
          <span id="pdRemaining" class="tmr-value">--</span>
        </div>

        <div class="r2k-meta">
          <span>Window:</span>
          <span id="pdWindow" class="strong">--</span>
        </div>

        <div id="pdError" class="r2k-meta" style="display:none;color:#ff7a7a;">
          API error: <span id="pdErrorText" class="strong" style="color:#ffb3b3;">--</span>
        </div>

        <div class="pd-actions">
          <a class="prev-lb-btn" id="pdSignupBtn" href="#" target="_blank" rel="noopener" style="margin:12px 0 0;">
            SIGN UP
          </a>
        </div>
      </div>
    </div>

  </div>

  <!-- Footer (kept minimal) -->
  <div data-v-5867ad71 class="row inner-footer">
    <div data-v-5867ad71 class="col-5">
      <div data-v-5867ad71 class="content">
        <div data-v-5867ad71 class="company"></div><br data-v-5867ad71>
        <span data-v-5867ad71 class="copyright">R2Ktwo<br data-v-5867ad71> All Right Reserved 2025.</span>
      </div>
    </div>

    <div class="col">
      <span class="title">Socials</span>
      <div class="footer-socials">
        <a href="https://kick.com/R2Ktwo" target="_blank" class="social" rel="noopener">
          <img src="/assets/kick.png" alt="Kick Logo" class="social-img"><span>Kick</span>
        </a>
        <a href="https://discord.gg/DwpA8vaGPj" target="_blank" class="social" rel="noopener">
          <img src="/assets/discord.png" alt="Discord Logo" class="social-img"><span>Discord</span>
        </a>
      </div>
    </div>

    <div data-v-5867ad71 class="col">
      <span data-v-5867ad71 class="title">ResponsibleGambling.org</span>
      <span data-v-5867ad71 class="subtitle" style="font-size:9px;">Remember: Gambling over a long period will always result in losses. Please set limits and gamble responsibly.</span>
    </div>
  </div>

  <!-- Existing JS includes -->
  <script src="/js/app.js"></script>
  <script src="/js/particles.js"></script>
  <script src="/js/toast.js"></script>

  <!-- Push content below sticky header -->
  <script>
    (function(){
      function pushBelowHeader(){
        const header = document.getElementById('r2kHeader');
        const app = document.getElementById('appContent');
        if(header && app){
          app.style.marginTop = header.offsetHeight + 'px';
        }
      }
      window.addEventListener('load', pushBelowHeader);
      window.addEventListener('resize', pushBelowHeader);
    })();
  </script>

  <!-- ✅ Packdraw total + time logic (works with your existing layout) -->
  <script>
    (function(){
      const PACKDRAW_API_KEY    = "edadb58b-ea99-4c27-9b91-60b84c095ee9";
      const PACKDRAW_BASE       = "https://packdraw.com/api/v1/affiliates/leaderboard";
      const PACKDRAW_SIGNUP_URL = "https://packdraw.com?ref=R2K2";

      // Hook up signup buttons
      const joinBtn = document.getElementById("joinPackdrawBtn");
      if(joinBtn) joinBtn.href = PACKDRAW_SIGNUP_URL;

      const signupBtn = document.getElementById("pdSignupBtn");
      if(signupBtn) signupBtn.href = PACKDRAW_SIGNUP_URL;

      // NY helpers
      function nyParts(date = new Date()){
        const f = new Intl.DateTimeFormat("en-US",{
          timeZone:"America/New_York",
          year:"numeric",month:"numeric",day:"numeric",
          hour:"numeric",minute:"numeric",second:"numeric",
          hour12:false
        });
        const parts = f.formatToParts(date);
        const get = t => Number(parts.find(p=>p.type===t)?.value);
        return { y:get("year"), m1:get("month"), d:get("day") };
      }
      function pad2(n){ return String(n).padStart(2,"0"); }
      function iso(y,m1,d){ return `${y}-${pad2(m1)}-${pad2(d)}`; }

      // Packdraw wants M-D-YYYY no zero padding
      function isoToMDY(isoStr){
        const [y,m,d] = isoStr.split("-").map(Number);
        return `${m}-${d}-${y}`;
      }

      // Current month window (NY)
      function monthWindow(){
        const now = nyParts();
        const y = now.y, m1 = now.m1;
        const startISO = iso(y, m1, 1);
        const lastDay = new Date(Date.UTC(y, m1, 0)).getUTCDate();
        const endISO = iso(y, m1, lastDay);

        // good enough for Jan (your case). If you later need DST-perfect, we can adjust.
        const endInstantET = new Date(`${endISO}T23:59:59-05:00`);
        return { startISO, endISO, endInstantUTC: endInstantET };
      }

      function toNum(v){
        if(v == null) return 0;
        if(typeof v === "number") return Number.isFinite(v) ? v : 0;
        const s = String(v).replace(/[$, ]/g,"").trim();
        const n = Number(s);
        return Number.isFinite(n) ? n : 0;
      }
      function pick(obj, keys){
        for(const k of keys){
          if(obj && obj[k] != null) return obj[k];
        }
        return undefined;
      }
      function normalize(data){
        return (data && Array.isArray(data.affiliates) && data.affiliates)
          || (data && Array.isArray(data.data) && data.data)
          || (Array.isArray(data) && data)
          || [];
      }
      function fmtMoney(n){
        const num = Number(n) || 0;
        try{ return num.toLocaleString(undefined,{style:"currency",currency:"USD",maximumFractionDigits:2}); }
        catch{ return "$" + (Math.round(num*100)/100).toFixed(2); }
      }

      async function fetchPackdraw(afterISO){
        const afterMDY = isoToMDY(afterISO);
        const url = `${PACKDRAW_BASE}?after=${encodeURIComponent(afterMDY)}&apiKey=${encodeURIComponent(PACKDRAW_API_KEY)}`;
        const res = await fetch(url,{cache:"no-store"});
        if(!res.ok){
          const text = await res.text().catch(()=> "");
          throw new Error(`HTTP ${res.status} ${res.statusText} ${text.slice(0,140)}`);
        }
        return await res.json();
      }

      async function fetchTotal(startISO){
        const data = await fetchPackdraw(startISO);
        const raw = normalize(data);

        // Sum known wager fields
        return raw.reduce((sum,a)=>{
          const w = toNum(pick(a, [
            "wagered_amount","wageredAmount","wagered","total_wagered","totalWagered","amount","volume"
          ])) || 0;
          return sum + w;
        }, 0);
      }

      function fmtRemaining(ms){
        const s = Math.max(0, Math.floor(ms/1000));
        const d = Math.floor(s/86400);
        const h = Math.floor((s%86400)/3600);
        const m = Math.floor((s%3600)/60);
        if(d>0) return `${d}d ${h}h ${m}m`;
        if(h>0) return `${h}h ${m}m`;
        return `${m}m`;
      }

      const totalEl = document.getElementById("pdTotal");
      const remEl   = document.getElementById("pdRemaining");
      const winEl   = document.getElementById("pdWindow");
      const errWrap = document.getElementById("pdError");
      const errText = document.getElementById("pdErrorText");

      let win = monthWindow();

      async function paint(){
        errWrap.style.display = "none";
        totalEl.textContent = "…";
        winEl.textContent = `${win.startISO} → ${win.endISO}`;

        try{
          const total = await fetchTotal(win.startISO);
          totalEl.textContent = fmtMoney(total);
        }catch(e){
          totalEl.textContent = "$0";
          errWrap.style.display = "flex";
          errText.textContent = String(e).slice(0, 120);
          console.error(e);
        }
      }

      function tick(){
        remEl.textContent = fmtRemaining(win.endInstantUTC.getTime() - Date.now());
      }

      // Hamburger (kept)
      (function(){
        const burger = document.getElementById('hamburger');
        const nav = document.getElementById('r2kNav');
        if(burger && nav){
          burger.addEventListener('click', ()=>{
            const isOpen = nav.classList.toggle('show');
            burger.setAttribute('aria-expanded', String(isOpen));
          });
        }
      })();

      document.addEventListener("DOMContentLoaded", async ()=>{
        win = monthWindow();
        await paint();
        tick();
        clearInterval(window.__pdTick__);
        window.__pdTick__ = setInterval(tick, 1000);

        // refresh total every 15 mins
        clearInterval(window.__pdRefresh__);
        window.__pdRefresh__ = setInterval(paint, 15*60*1000);
      });
    })();
  </script>
</body>
</html>
