<!DOCTYPE html>
<html lang="en">
<head>
  <title>R2K2 | Packdraw Leaderboard</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Exclusive wager races on Packdraw for code R2K2!">
  <meta property="og:image" content="/assets/logo.png">
  <link rel="icon" type="image/png" href="/assets/logo.png">

  <!-- Global CSS -->
  <link rel="stylesheet" href="/css/app.css">
  <link rel="stylesheet" href="/css/lb.css">
  <link rel="stylesheet" href="/css/vendor.css">
  <link rel="stylesheet" href="/css/toast.css">
  <link rel="stylesheet" href="/css/theme.css">

  <style>
    .warning-message{
      width:90%;max-width:520px;margin:12px auto 0;background:rgba(255,0,0,.10);
      border:2px solid #ff4444;border-radius:10px;padding:14px;color:#ff4444;font-weight:900;
      text-align:center;box-sizing:border-box;
    }

    /* Center card */
    .pd-wrap{
      width:min(1100px,92%);
      margin:0 auto;
      padding: 18px 0 60px;
    }

    .pd-card{
      width:min(720px, 96vw);
      margin: 26px auto 0;
      background:#0b0f17;
      border:1px solid rgba(19,152,255,.35);
      border-radius:16px;
      box-shadow:0 0 28px rgba(19,152,255,.20);
      padding: 22px 22px 18px;
      position:relative;
      overflow:hidden;
    }

    .pd-card::before{
      content:"";
      position:absolute;
      inset:-1px;
      background: linear-gradient(135deg, rgba(19,152,255,.18), rgba(107,92,255,.18));
      opacity:.55;
      pointer-events:none;
    }

    .pd-card > *{ position:relative; z-index:1; }

    .pd-head{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:12px;
      margin-bottom: 12px;
    }

    .pd-head img{
      height: 46px;
      width:auto;
      object-fit:contain;
      filter: drop-shadow(0 0 14px rgba(19,152,255,.25));
    }

    .pd-title{
      text-align:center;
      font-weight: 1000;
      letter-spacing:.02em;
      color:#fff;
      text-shadow:0 0 18px rgba(19,152,255,.35);
      margin: 10px 0 6px;
      font-size: 34px;
      line-height:1.15;
    }

    .pd-sub{
      text-align:center;
      color: rgba(255,255,255,.86);
      font-weight:700;
      margin: 0 0 8px;
    }

    .pd-stats{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 14px;
      margin-top: 16px;
    }

    .pd-stat{
      background: rgba(8,20,35,.85);
      border:1px solid rgba(19,152,255,.25);
      border-radius:14px;
      padding: 14px 14px 12px;
      box-shadow: inset 0 0 10px rgba(19,152,255,.12);
    }

    .pd-label{
      font-size:12px;
      letter-spacing:.10em;
      text-transform:uppercase;
      color:#9fd4ff;
      font-weight:900;
    }

    .pd-value{
      margin-top:6px;
      font-size:28px;
      font-weight:1000;
      color:#fff;
      text-shadow:0 0 18px rgba(19,152,255,.35);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .pd-meta{
      margin-top: 10px;
      text-align:center;
      color: rgba(255,255,255,.70);
      font-weight:700;
      font-size: 13px;
    }

    .pd-actions{
      display:flex;
      justify-content:center;
      gap:12px;
      flex-wrap:wrap;
      margin-top: 16px;
    }

    .pd-btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding:12px 18px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      text-decoration:none;
      font-weight:1000;
      letter-spacing:.06em;
      text-transform:uppercase;
      background: linear-gradient(90deg, rgba(19,152,255,1), rgba(107,92,255,1));
      color:#05070b;
      box-shadow:0 0 22px rgba(19,152,255,.20);
      transition: transform .15s ease, box-shadow .15s ease;
    }
    .pd-btn:hover{
      transform: translateY(-1px);
      box-shadow:0 0 26px rgba(107,92,255,.25), 0 0 22px rgba(19,152,255,.20);
    }

    @media (max-width: 740px){
      .pd-title{ font-size: 28px; }
      .pd-value{ font-size: 22px; }
      .pd-stats{ grid-template-columns: 1fr; }
      .pd-head img{ height: 40px; }
    }
  </style>
</head>

<body>
  <div id="toast"><span id="message"></span></div>

  <!-- Header -->
  <header id="r2kHeader">
    <div class="h-inner">
      <a href="/" class="brand" aria-label="R2K2 Home">
        <img src="/assets/logo.png" class="logo" alt="R2K2">
        <div class="name">R2K<span class="accent">2</span></div>
      </a>

      <nav class="nav" id="r2kNav">
        <a href="/">Home</a>
        <a href="/leaderboard/packdraw">Leaderboard</a>
        <a href="/raffle">Raffle</a>
        <a href="/challenges">Challenges</a>
        <a href="/wagerbonus">Wager Bonus</a>
      </nav>

      <div class="hamburger" id="hamburger" aria-label="Menu" aria-controls="r2kNav" aria-expanded="false">
        <span></span><span></span><span></span>
      </div>
    </div>
  </header>

  <!-- Background -->
  <canvas id="particleCanvas"></canvas>
  <div class="glow-container"><div class="left-glow"></div><div class="right-glow"></div></div>
  <object type="image/png" data="/assets/left-packdraw.png" id="leftsvg" height="100%"></object>
  <object type="image/png" data="/assets/right-packdraw.png" id="rightsvg" height="100%"></object>

  <!-- Main -->
  <div id="appContent" class="pd-wrap" style="margin-top:50px;">
    <div class="row text" style="margin-top: 50px;">
      <span class="title">
        <div class="price-wrapper glow">$2,000</div>
        MONTHLY CODE <span class="glow">R2K2</span> Leaderboard!
      </span>

      <span class="subtitle" style="color:#FFF;">
        Every <b>WAGER</b> on Packdraw under Code <b>R2K2</b> counts towards your score. <br>
        <i>The leaderboard updates every 15 minutes.</i>
        <div class="warning-message">It Only Takes One!</div>
      </span>
    </div>

    <!-- Single status card -->
    <div class="pd-card" aria-label="Packdraw leaderboard status">
      <div class="pd-head">
        <img src="/assets/packdraw.png" alt="Packdraw">
      </div>

      <div class="pd-title">Packdraw Leaderboard</div>
      <div class="pd-sub">Live totals for Code <b>R2K2</b></div>

      <div class="pd-stats">
        <div class="pd-stat">
          <div class="pd-label">Total Wagered</div>
          <div class="pd-value" id="pdTotal">$0</div>
        </div>

        <div class="pd-stat">
          <div class="pd-label">Time Remaining</div>
          <div class="pd-value" id="pdRemaining">--</div>
        </div>
      </div>

      <div class="pd-meta" id="pdWindow">Window: --</div>

      <div class="pd-actions">
        <a class="pd-btn" href="https://packdraw.com?ref=R2K2" target="_blank" rel="noopener">Sign Up</a>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="/js/app.js"></script>
  <script src="/js/particles.js"></script>
  <script src="/js/toast.js"></script>

  <!-- Push below sticky header -->
  <script>
    (function(){
      function pushBelowHeader(){
        const header = document.getElementById('r2kHeader');
        const app = document.getElementById('appContent');
        if(header && app) app.style.marginTop = header.offsetHeight + 'px';
      }
      window.addEventListener('load', pushBelowHeader);
      window.addEventListener('resize', pushBelowHeader);
    })();
  </script>

  <!-- Hamburger -->
  <script>
    (function(){
      const burger = document.getElementById('hamburger');
      const nav = document.getElementById('r2kNav');
      if(burger && nav){
        burger.addEventListener('click', ()=>{
          const isOpen = nav.classList.toggle('show');
          burger.setAttribute('aria-expanded', String(isOpen));
        });
      }
    })();
  </script>

  <!-- Packdraw logic (total + remaining) -->
  <script>
    (function(){
      const PACKDRAW_API_KEY = "edadb58b-ea99-4c27-9b91-60b84c095ee9";
      const PACKDRAW_BASE    = "https://packdraw.com/api/v1/affiliates/leaderboard";

      // Monthly window (current month in New York time)
      function nyParts(date = new Date()){
        const f = new Intl.DateTimeFormat("en-US",{
          timeZone:"America/New_York",
          year:"numeric",month:"numeric",day:"numeric",
          hour:"numeric",minute:"numeric",second:"numeric",
          hour12:false
        });
        const parts = f.formatToParts(date);
        const get = t => Number(parts.find(p=>p.type===t)?.value);
        return { y:get("year"), m1:get("month"), d:get("day") };
      }
      function pad2(n){ return String(n).padStart(2,"0"); }
      function iso(y,m1,d){ return `${y}-${pad2(m1)}-${pad2(d)}`; }

      // Packdraw expects M-D-YYYY (no zero pad)
      function isoToMDY(isoStr){
        const [y,m,d] = isoStr.split("-").map(Number);
        return `${m}-${d}-${y}`;
      }

      function monthWindow(){
        const now = nyParts();
        const y = now.y, m1 = now.m1;
        const startISO = iso(y, m1, 1);
        const lastDay = new Date(Date.UTC(y, m1, 0)).getUTCDate();
        const endISO = iso(y, m1, lastDay);
        const endInstantET = new Date(`${endISO}T23:59:59-05:00`);
        return { startISO, endISO, endInstantUTC: endInstantET };
      }

      function toNum(v){
        if(v == null) return 0;
        if(typeof v === "number") return Number.isFinite(v) ? v : 0;
        const s = String(v).replace(/[$, ]/g,"").trim();
        const n = Number(s);
        return Number.isFinite(n) ? n : 0;
      }

      function pick(obj, keys){
        for(const k of keys){
          if(obj && obj[k] != null) return obj[k];
        }
        return undefined;
      }

      function normalize(data){
        return (data && Array.isArray(data.affiliates) && data.affiliates)
          || (data && Array.isArray(data.data) && data.data)
          || (Array.isArray(data) && data)
          || [];
      }

      function fmtMoney(n){
        const num = Number(n) || 0;
        try{ return num.toLocaleString(undefined,{style:"currency",currency:"USD",maximumFractionDigits:2}); }
        catch{ return "$" + (Math.round(num*100)/100).toFixed(2); }
      }

      async function fetchPackdraw(afterISO){
        const afterMDY = isoToMDY(afterISO);
        const url = `${PACKDRAW_BASE}?after=${encodeURIComponent(afterMDY)}&apiKey=${encodeURIComponent(PACKDRAW_API_KEY)}`;
        const res = await fetch(url, { cache:"no-store" });
        if(!res.ok){
          const t = await res.text().catch(()=> "");
          throw new Error(`HTTP ${res.status} ${res.statusText}\n${t.slice(0,250)}`);
        }
        return await res.json();
      }

      async function fetchTotal(startISO, endISO){
        const data = await fetchPackdraw(startISO);
        let raw = normalize(data);

        // If entries have timestamps, we try to filter to month window. If not, we keep all.
        const start = new Date(startISO + "T00:00:00Z").getTime();
        const end   = new Date(endISO + "T23:59:59Z").getTime();

        raw = raw.filter(r=>{
          const dt = pick(r, ["date","created_at","createdAt","timestamp","time"]);
          if(!dt) return true;
          const t = (typeof dt === "number") ? dt : Date.parse(dt);
          if(!Number.isFinite(t)) return true;
          return t >= start && t <= end;
        });

        return raw.reduce((sum,a)=>{
          const w =
            toNum(pick(a, ["wagered_amount","wageredAmount","wagered","total_wagered","totalWagered","amount","volume"])) || 0;
          return sum + w;
        }, 0);
      }

      function fmtRemaining(ms){
        const s = Math.max(0, Math.floor(ms/1000));
        const d = Math.floor(s/86400);
        const h = Math.floor((s%86400)/3600);
        const m = Math.floor((s%3600)/60);
        const ss= s%60;
        if(d>0) return `${d}d ${h}h ${m}m`;
        if(h>0) return `${h}h ${m}m ${ss}s`;
        if(m>0) return `${m}m ${ss}s`;
        return `${ss}s`;
      }

      const totalEl = document.getElementById("pdTotal");
      const remEl   = document.getElementById("pdRemaining");
      const winEl   = document.getElementById("pdWindow");

      let win = monthWindow();

      async function paint(){
        try{
          totalEl.textContent = "…";
          const total = await fetchTotal(win.startISO, win.endISO);
          totalEl.textContent = fmtMoney(total);
          winEl.textContent = `Window: ${win.startISO} → ${win.endISO}`;
        }catch(e){
          totalEl.textContent = "$0";
          winEl.textContent = "Window: unavailable";
          console.error(e);
        }
      }

      function tick(){
        remEl.textContent = fmtRemaining(win.endInstantUTC.getTime() - Date.now());
      }

      document.addEventListener("DOMContentLoaded", async ()=>{
        win = monthWindow();
        await paint();
        tick();
        clearInterval(window.__pdTick__);
        window.__pdTick__ = setInterval(tick, 1000);

        // refresh total every 15 mins
        clearInterval(window.__pdRefresh__);
        window.__pdRefresh__ = setInterval(paint, 15 * 60 * 1000);
      });
    })();
  </script>
</body>
</html>
