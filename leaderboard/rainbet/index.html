<!DOCTYPE html>
<html lang="en">
<head>
  <title>R2K2 | Rainbet Leaderboard</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Exclusive wager races on Rainbet for code R2K2!">
  <meta property="og:image" content="/assets/logo.png">
  <link rel="icon" type="image/png" href="/assets/logo.png">

  <!-- Global CSS (kept) -->
  <link rel="stylesheet" href="/css/app.css">
  <link rel="stylesheet" href="/css/lb.css">
  <link rel="stylesheet" href="/css/vendor.css">
  <link rel="stylesheet" href="/css/toast.css">

  <script src="/js/countdown-roobet.js"></script>

  <style>
    .warning-message{
      width:90%;max-width:500px;margin:10px auto;background:rgba(255,0,0,.1);
      border:2px solid #ff4444;border-radius:4px;padding:15px;color:#ff4444;font-weight:700;
      text-align:center;box-sizing:border-box;
    }
    @media (max-width:768px){.warning-message{width:95%;padding:12px;font-size:14px;margin:10px auto}}

    /* ===== Modal (kept) ===== */
    .modal{display:none;position:fixed;z-index:1000;inset:0;overflow:auto;background:rgba(0,0,0,.7);opacity:0;transition:opacity .5s}
    .modal.show{opacity:1}
    .modal-content{
      background:linear-gradient(135deg,#1f2937,#111827);margin:10% auto;padding:25px;border:1px solid rgba(255,255,255,.1);
      border-radius:12px;width:80%;max-width:600px;box-shadow:0 10px 25px rgba(0,0,0,.5);transform:translateY(-20px);transition:.5s;position:relative
    }
    .modal.show .modal-content{transform:translateY(0)}
    .modal-header{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid rgba(255,255,255,.1);padding-bottom:15px;margin-bottom:15px}
    .modal-title{font-size:24px;font-weight:700;color:#fff;margin:0}
    .close{color:#aaa;font-size:28px;font-weight:700;cursor:pointer;transition:color .2s}
    .close:hover{color:#fff}
    .modal-body{color:#d1d5db;font-size:16px;line-height:1.6}
    .modal-body li{margin-bottom:10px;text-align:left}
    .modal-body ul{padding-left:20px}

    /* ===== Totals + progress (kept) ===== */
    .r2k-totals{display:flex;justify-content:center;align-items:stretch;flex-wrap:wrap;gap:30px;margin:28px auto 10px;width:min(1080px,92%)}
    .r2k-total-card{flex:0 1 360px;background:#0b0f17;border:1px solid #0e2038;border-radius:14px;padding:18px 20px;box-shadow:0 0 18px rgba(0,153,255,.25)}
    .r2k-total-label{font-size:12px;letter-spacing:.08em;text-transform:uppercase;color:#87c8ff;opacity:.9}
    .r2k-total-value{margin-top:6px;font-weight:700;font-size:22px;line-height:1.2;color:#e9f5ff;text-shadow:0 0 10px rgba(0,153,255,.35);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .r2k-progress{margin-top:10px}
    .r2k-progress-bar{height:10px;background:rgba(8,20,35,.9);border:1px solid #0e2038;border-radius:999px;overflow:hidden;box-shadow:inset 0 0 10px rgba(0,153,255,.15),0 0 14px rgba(0,153,255,.15)}
    .r2k-progress-fill{height:100%;width:0;transition:width 900ms ease-in-out;background:linear-gradient(90deg,#1398ff,#48c7ff);box-shadow:0 0 12px rgba(0,153,255,.55)}
    .r2k-progress-fill.over{background:linear-gradient(90deg,#22c55e,#86efac);box-shadow:0 0 12px rgba(34,197,94,.55)}
    .r2k-progress-meta{display:flex;justify-content:space-between;align-items:center;font-size:12px;color:#87c8ff;opacity:.95;margin-top:6px}
    .r2k-progress-meta .strong{color:#e9f5ff;font-weight:700}

    .tmr{display:flex;align-items:center;gap:10px;margin-top:12px}
    .tmr-label{color:#b6d9ff;font-weight:900;letter-spacing:.06em;text-transform:uppercase;text-shadow:0 0 10px rgba(19,152,255,.45)}
    .tmr-value{color:#fff;font-weight:900;letter-spacing:.5px;font-size:18px;text-shadow:0 0 16px rgba(19,152,255,.8),0 0 25px rgba(19,152,255,.4)}
    @media (max-width:640px){.tmr-value{font-size:16px}}

    .prev-lb-btn{display:inline-flex;align-items:center;gap:8px;background:#2775ca;color:#000;padding:12px 24px;border-radius:8px;text-decoration:none;font-weight:600;border:2px solid rgba(255,255,255,.2);box-shadow:0 4px 15px rgba(39,117,202,.2);position:relative;overflow:hidden;margin:10px 10px 10px 0;transition:all .2s cubic-bezier(.4,0,.2,1)}
    .prev-lb-btn:hover{transform:translateY(-2px) scale(1.02);background:#2775ca;box-shadow:0 6px 20px rgba(39,117,202,.4);border-color:rgba(255,255,255,.4);color:#000;text-decoration:none}
    .prev-lb-btn svg{width:18px;height:18px}
    @media (max-width:768px){.prev-lb-btn{width:100%;margin-right:0;text-align:center;justify-content:center}}

    /* ===== Leaderboard lists ===== */
    #leaderboard-rows{
      width:min(1120px,95%);
      margin:18px auto 40px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .lb-row{
      display:grid;
      grid-template-columns: 54px 64px 1fr auto auto;
      align-items:center;
      gap:14px;
      padding:16px 18px;
      background:#0b0f17;
      border:1px solid #0e2038;
      border-radius:14px;
      box-shadow:0 0 18px rgba(0,153,255,.15);
    }
    .lb-row--wide{padding:18px 22px}
    .lb-rank{font-size:18px;font-weight:900;color:#e9f5ff}
    .lb-name{font-size:16px;font-weight:800;color:#d6ecff;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

    .lb-right{display:flex;align-items:baseline;gap:min(8vw,64px)}
    .lb-label{font-size:12px;color:#9ac9ff;font-weight:800;text-transform:uppercase;letter-spacing:.08em;opacity:.9;margin-right:8px}

    .lb-row .lb-money.wager{font-size:18px;color:#ffffff !important;-webkit-text-fill-color:#ffffff !important;text-shadow:0 0 8px rgba(19,152,255,.25);}
    .lb-row .lb-money.prize{font-size:18px;color:#39ff93;text-shadow:0 0 6px rgba(57,255,147,.85),0 0 14px rgba(57,255,147,.55),0 0 28px rgba(57,255,147,.35);}

    @media (max-width:720px){
      .lb-row{grid-template-columns:44px 54px 1fr;gap:10px}
      .lb-right{grid-column:1 / -1;justify-content:space-between;margin-top:8px;gap:22px}
      .lb-row .lb-money.wager,.lb-row .lb-money.prize{font-size:17px}
      .lb-row--wide .lb-money.wager,.lb-row--wide .lb-money.prize{font-size:18px}
      .lb-name{font-size:15px}
    }

    #top3-cards{
      display:flex;gap:14px;justify-content:center;flex-wrap:wrap;
      width:min(1120px,95%);margin:10px auto 24px;
    }
    .top-card-shadow-1{box-shadow:0 0 40px #FFD700}
    .top-card-shadow-2{box-shadow:0 0 40px #C0C0C0}
    .top-card-shadow-3{box-shadow:0 0 40px #CD7F32}
  </style>
</head>

<body>
  <div id="toast"><span id="message"></span></div>

  <!-- Header -->
  <header id="r2kHeader">
    <div class="h-inner">
      <a href="/" class="brand" aria-label="R2K2 Home">
        <img src="/assets/logo.png" class="logo" alt="R2K2">
        <div class="name">R2K<span class="accent">2</span></div>
      </a>

      <nav class="nav" id="r2kNav">
        <a href="/">Home</a>
        <a href="/leaderboard/rainbet">Leaderboard</a>
        <a href="/raffle" aria-current="page">Raffle</a>
        <a href="/challenges">Challenges</a>
      </nav>

      <div class="actions">
        <a class="btn" href="https://rainbet.com/?r=r2k2" target="_blank" rel="noopener">Join Rainbet</a>
      </div>

      <div class="hamburger" id="hamburger" aria-label="Menu" aria-controls="r2kNav" aria-expanded="false">
        <span></span><span></span><span></span>
      </div>
    </div>
  </header>

  <canvas id="particleCanvas"></canvas>

  <div class="glow-container"><div class="left-glow"></div><div class="right-glow"></div></div>
  <object type="image/png" data="/assets/left-rainbet.png" id="leftsvg" height="100%"></object>
  <object type="image/png" data="/assets/right-rainbet.png" id="rightsvg" height="100%"></object>

  <!-- Toggle -->
  <div class="toggle-images" style="margin-top:50px;">
    <img class="game-image roobet-image" id="roobetImage" src="/assets/rainbet.png"
         style="cursor:pointer;opacity:1;" onclick="window.location.href='/leaderboard/rainbet'">
  </div>

  <div id="appContent">
    <div class="row text">
      <span class="title">
  <div class="price-wrapper glow">$3,000</div>
  MONTHLY CODE <span class="glow">R2K2</span> Leaderboard!
</span>
<br>  <!-- THIS WAS MISSING -->

<span class="subtitle" style="color:#FFF;">
  Every <b>BET</b> on Rainbet under Code <b>R2K2</b> counts towards your score. <br>
  <i>The leaderboard updates every 15 minutes.</i><br>


        <div class="warning-message">It Only Takes One!</div>

        <button id="rulesButton" class="prev-lb-btn" style="background:#FFFFFF;cursor:pointer;border:none;color:#000;">
          RULES
        </button>

        <button id="prevLeaderboardBtn" class="prev-lb-btn">
          PREVIOUS LEADERBOARD
        </button>

        <button id="currentLeaderboardBtn" class="prev-lb-btn"
                style="display:none;background:#22c55e;color:#000;">
          CURRENT LEADERBOARD
        </button>
      </span>
    </div>

    <div class="r2k-totals">
      <div class="r2k-total-card">
        <div class="r2k-total-label">Current Deal</div>
        <div class="r2k-total-value" id="r2kDealWager">$0</div>
        <div class="r2k-progress">
          <div class="r2k-progress-bar" id="r2kDealBar">
            <div class="r2k-progress-fill" id="r2kDealFill"></div>
          </div>
          <div class="r2k-progress-meta">
            <span id="r2kDealPct" class="strong">0%</span>
            <span id="r2kDealMeta">$0 / $0</span>
          </div>
        </div>
        <div class="tmr">
          <span class="tmr-label">ENDING IN</span>
          <span id="deal-remaining" class="tmr-value">--</span>
        </div>
      </div>

      <div class="r2k-total-card">
        <div class="r2k-total-label">Current Leaderboard</div>
        <div class="r2k-total-value" id="r2kLbWager">$0</div>
        <div class="r2k-progress">
          <div class="r2k-progress-bar" id="r2kLbBar">
            <div class="r2k-progress-fill" id="r2kLbFill"></div>
          </div>
          <div class="r2k-progress-meta">
            <span id="r2kLbPct" class="strong">0%</span>
            <span id="r2kLbMeta">$0 / $0</span>
          </div>
        </div>
        <div class="tmr">
          <span class="tmr-label">ENDING IN</span>
          <span id="lb-remaining" class="tmr-value">--</span>
        </div>
      </div>
    </div>

    <div class="css-esk2ah">
      <div class="css-2w2ovy">
        <div id="top3-cards"></div>
        <div id="leaderboard-rows"></div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <div class="row inner-footer">
    <div class="col-5">
      <div class="content">
        <div class="company"></div><br>
        <span class="copyright">R2Ktwo<br> All Right Reserved 2025.</span>
      </div>
    </div>

    <div class="col">
      <span class="title">Socials</span>
      <div class="footer-socials">
        <a href="https://kick.com/R2Ktwo" target="_blank" class="social">
          <img src="/assets/kick.png" class="social-img"><span>Kick</span>
        </a>
        <a href="https://discord.gg/DwpA8vaGPj" target="_blank" class="social">
          <img src="/assets/discord.png" class="social-img"><span>Discord</span>
        </a>
      </div>
    </div>

    <div class="col">
      <span class="title">ResponsibleGambling.org</span>
      <span class="subtitle" style="font-size:9px;">
        Remember: Gambling over a long period will always result in losses.
      </span>
    </div>
  </div>

  <script defer src="https://static.cloudflareinsights.com/beacon.min.js"></script>

  <!-- Modal behavior -->
  <script>
    const modal = document.getElementById("rulesModal");
    const btn = document.getElementById("rulesButton");
    const span = document.getElementsByClassName("close")[0];

    btn?.addEventListener('click', ()=>{
      if(!modal) return;
      modal.style.display="block";
      document.body.style.overflow="hidden";
      setTimeout(()=>modal.classList.add("show"),10)
    });

    function closeModal(){
      if(!modal) return;
      modal.classList.remove("show");
      setTimeout(()=>{
        modal.style.display="none";
        document.body.style.overflow="auto";
      },500)
    }

    span?.addEventListener('click', closeModal);
    window.addEventListener('click',(e)=>{ if(e.target===modal) closeModal(); });
    document.addEventListener('keydown',(e)=>{ if(e.key==='Escape' && modal && modal.style.display==='block') closeModal(); });
  </script>

  <script src="/js/app.js"></script>
  <script src="/js/particles.js"></script>
  <script src="/js/toast.js"></script>

  <!-- Header spacing (single copy, NOT duplicated) -->
  <script>
    (function(){
      function pushBelowHeader(){
        const header = document.getElementById('r2kHeader');
        const app = document.getElementById('appContent');
        if(header && app){
          app.style.marginTop = header.offsetHeight + 'px';
        }
      }
      window.addEventListener('load', pushBelowHeader);
      window.addEventListener('resize', pushBelowHeader);
    })();
  </script>

  <!-- ========== FIXED LEADERBOARD LOGIC ========== -->
  <script>
(function(){
  const API_ROUTE = "/api/leaderboard";
  const DEAL_GOAL = 1200000;
  const LB_GOAL   = 2250000;

  // Deal window (unchanged)
  const DEAL_START = "2025-11-02";
  const DEAL_END   = "2025-12-01";

  // FIX: Current LB window = 11/25 â†’ 12/31
  function currentLBWindow(){
    return {
      startISO: "2025-11-25",
      endISO: "2025-12-31",
      endInstantUTC: new Date("2025-12-31T23:59:59-05:00")
    };
  }

  // Previous LB = deal window + 30 days
  const LB_EXTRA_DAYS = 30;
  const MS_DAY = 86400000;

  function isoDate(d){return d.toISOString().slice(0,10);}
  function parseISO(s){const [y,m,d]=s.split("-").map(Number);return{y,m1:m,d};}

  function boundaryUTC(y,m1,d){
    return new Date(Date.UTC(y, m1-1, d, 20,0,0)); // 8pm ET
  }

  function apiDateFromBoundary(dtUTC){
    return isoDate(new Date(Date.UTC(
      dtUTC.getUTCFullYear(),
      dtUTC.getUTCMonth(),
      dtUTC.getUTCDate()+1
    )));
  }

  function oldLBWindowFromDeal(){
    const ds=parseISO(DEAL_START);
    const de=parseISO(DEAL_END);

    const startUTC=boundaryUTC(ds.y,ds.m1,ds.d);
    const dealEndUTC=boundaryUTC(de.y,de.m1,de.d);
    const endUTC=new Date(dealEndUTC.getTime()+LB_EXTRA_DAYS*MS_DAY);

    return{
      startUTC,
      endUTC,
      winLen:endUTC-startUTC,
      startISO:apiDateFromBoundary(startUTC),
      endISO:apiDateFromBoundary(endUTC),
      endInstantUTC:endUTC
    };
  }

  function previousLBWindow(){
    const old=oldLBWindowFromDeal();
    const prevEndUTC=old.startUTC;
    const prevStartUTC=new Date(prevEndUTC-old.winLen);
    return{
      startISO:apiDateFromBoundary(prevStartUTC),
      endISO:apiDateFromBoundary(prevEndUTC),
      endInstantUTC:prevEndUTC
    };
  }

  function fmtMoney(n){
    return "$" + Number(n).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
  }
  function toNum(v){return Number(v)||0;}

  async function fetchTotal(startISO,endISO){
    const url=`${API_ROUTE}?start_at=${startISO}&end_at=${endISO}`;
    const r=await fetch(url,{cache:"no-store"});
    const j=await r.json();
    const arr=j.affiliates||[];
    return arr.reduce((s,a)=>s+toNum(a.wagered_amount),0);
  }

  async function fetchRows(startISO,endISO){
    const url=`${API_ROUTE}?start_at=${startISO}&end_at=${endISO}`;
    const r=await fetch(url,{cache:"no-store"});
    const j=await r.json();
    const arr=j.affiliates||[];
    return arr
      .map(a=>({username:a.username,wagered:toNum(a.wagered_amount)}))
      .filter(a=>a.wagered>0)
      .sort((a,b)=>b.wagered-a.wagered)
      .slice(0,10);
  }

  const logoSrc="/assets/rainbetlogo.png";
  const rewards=[900,575,400,350,250,200,150,100,50,25];

  function maskName(s){
    if(!s)return"Unknown";
    s=String(s);
    if(s.length<=3)return s;
    return s.slice(0,2)+"*".repeat(s.length-3)+s.slice(-1);
  }

  function renderTop3(rows){
    const el=document.getElementById("top3-cards");
    el.innerHTML="";
    const glows=["top-card-shadow-1","top-card-shadow-2","top-card-shadow-3"];
    rows.slice(0,3).forEach((e,i)=>{
      const div=document.createElement("div");
      div.className=`css-jehefp ${glows[i]||""}`;
      div.style.position="relative";
      if(i===1)div.style.transform="translateY(25px) scale(1.2)";
      if(i===2)div.style.transform="translateY(25px)";
      div.innerHTML=`
        <div style="position:absolute;top:8px;left:8px;background:rgba(0,0,0,.45);
                    padding:4px 8px;border-radius:8px;font-weight:700;">#${i+1}</div>
        <img src="${logoSrc}" style="width:96px;height:auto;border-radius:12px;">
        <div class="css-hca0vm"><span class="css-15a1lq3" style="font-weight:bold;">${maskName(e.username)}</span></div>
        <div style="margin:8px 0 6px;color:#9ac9ff;font-weight:800;">Wagered</div>
        <div style="padding:10px 18px;border:1px solid #1b3760;background:#0c1a2d;border-radius:12px;">
          <span style="font-weight:900;color:#fff;">${fmtMoney(e.wagered)}</span>
        </div>
        <div style="margin-top:10px;font-weight:900;color:#39ff93;">${fmtMoney(rewards[i])}</div>
      `;
      el.appendChild(div);
    });
  }

  function renderRows(rows){
    const el=document.getElementById("leaderboard-rows");
    el.innerHTML="";
    rows.slice(3).forEach((e,idx)=>{
      const rank=idx+4;
      const div=document.createElement("div");
      div.className="lb-row lb-row--wide";
      div.innerHTML=`
        <img src="${logoSrc}" style="width:44px;height:44px;border-radius:10px;border:1px solid #143255;background:#0b1220;">
        <div class="lb-rank">#${rank}</div>
        <div class="lb-name">${maskName(e.username)}</div>
        <div class="lb-right">
          <div>
            <span class="lb-label">Wagered</span>
            <span class="lb-money wager">${fmtMoney(e.wagered)}</span>
          </div>
          <div>
            <span class="lb-label">Prize</span>
            <span class="lb-money prize">${fmtMoney(rewards[rank-1])}</span>
          </div>
        </div>`;
      el.appendChild(div);
    });
  }

  async function paintListCurrent(){
    const w=currentLBWindow();
    const rows=await fetchRows(w.startISO,w.endISO);
    renderTop3(rows);
    renderRows(rows);
  }

  async function paintListPrevious(){
    const w=previousLBWindow();
    const rows=await fetchRows(w.startISO,w.endISO);
    renderTop3(rows);
    renderRows(rows);
  }

  function renderProgress({total,goal,fillId,pctId,metaId,barId}){
    const fill=document.getElementById(fillId);
    const pct=document.getElementById(pctId);
    const meta=document.getElementById(metaId);
    const bar=document.getElementById(barId);
    const p=goal?Math.min((total/goal)*100,100):0;
    fill.style.width=p+"%";
    fill.classList.toggle("over",p>=100);
    pct.textContent=Math.round(p)+"%";
    meta.textContent=`${fmtMoney(total)} / ${fmtMoney(goal)}`;
    bar.setAttribute("aria-valuenow",Math.round(p));
  }

  async function paintTotals(){
    const dealTotal=await fetchTotal(DEAL_START,DEAL_END);
    document.getElementById("r2kDealWager").textContent=fmtMoney(dealTotal);
    renderProgress({
      total:dealTotal,goal:DEAL_GOAL,
      fillId:"r2kDealFill",pctId:"r2kDealPct",
      metaId:"r2kDealMeta",barId:"r2kDealBar"
    });

    const w=currentLBWindow();
    const lbTotal=await fetchTotal(w.startISO,w.endISO);
    document.getElementById("r2kLbWager").textContent=fmtMoney(lbTotal);
    renderProgress({
      total:lbTotal,goal:LB_GOAL,
      fillId:"r2kLbFill",pctId:"r2kLbPct",
      metaId:"r2kLbMeta",barId:"r2kLbBar"
    });
  }

  function fmtRemaining(ms){
    const s=Math.max(0,Math.floor(ms/1000));
    const d=Math.floor(s/86400);
    const h=Math.floor((s%86400)/3600);
    const m=Math.floor((s%3600)/60);
    const ss=s%60;
    if(d>0)return`${d}d ${h}h ${m}m`;
    if(h>0)return`${h}h ${m}m ${ss}s`;
    if(m>0)return`${m}m ${ss}s`;
    return`${ss}s`;
  }

  function tickCountdowns(){
    const dealSpan=document.getElementById('deal-remaining');
    const dealMs=new Date(DEAL_END+"T23:59:59").getTime()-Date.now();
    dealSpan.textContent=fmtRemaining(dealMs);

    const lbSpan=document.getElementById('lb-remaining');
    const w=currentLBWindow();
    const lbMs=w.endInstantUTC-Date.now();
    lbSpan.textContent=fmtRemaining(lbMs);
  }

  const prevBtn=document.getElementById("prevLeaderboardBtn");
  const currBtn=document.getElementById("currentLeaderboardBtn");

  prevBtn.addEventListener("click",async()=>{
    prevBtn.style.display="none";
    currBtn.style.display="inline-flex";
    await paintListPrevious();
  });

  currBtn.addEventListener("click",async()=>{
    currBtn.style.display="none";
    prevBtn.style.display="inline-flex";
    await paintListCurrent();
  });

  (function(){
    const burger=document.getElementById('hamburger');
    const nav=document.getElementById('r2kNav');
    burger?.addEventListener('click',()=>{
      const isOpen=nav.classList.toggle('show');
      burger.setAttribute('aria-expanded',String(isOpen));
    });
  })();

  document.addEventListener("DOMContentLoaded",async()=>{
    await paintTotals();
    await paintListCurrent();
    tickCountdowns();
    setInterval(tickCountdowns,1000);
  });

})();
  </script>

</body>
</html>
