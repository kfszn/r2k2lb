<!DOCTYPE html>
<html lang="en">
<head>
  <title>R2K2 | Active Raffles</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Active raffles for the R2K2 community. Wager to enter and win!" />
  <meta property="og:image" content="/assets/logo.png" />
  <link rel="icon" type="image/png" href="/assets/logo.png" />

  <!-- Keep site CSS identical to other pages -->
  <link rel="stylesheet" href="/css/app.css" />
  <link rel="stylesheet" href="/css/vendor.css" />
  <link rel="stylesheet" href="/css/toast.css" />

  <style>
    :root{
      --bg-deep:#070b12;
      --card:#0b0f17;
      --border:#1b2a40;
      --ink:#e9f5ff;
      --muted:#a6c9ef;
      --accent:#6b5cff;
      --blue:#1398ff;
    }
    html,body{background:var(--bg-deep);color:var(--ink);margin:0}

    /* ===== Header (simplified to: Home | Leaderboard | Raffle | Challenges) ===== */
    #r2kHeader{
      position:sticky; top:0; z-index:2000;
      background:linear-gradient(180deg, rgba(7,10,16,0.98) 0%, rgba(5,8,13,0.98) 85%, rgba(3,5,9,1) 100%);
      backdrop-filter:blur(6px);
      border:none !important;
      box-shadow:0 4px 12px rgba(0,0,0,.4);
    }
    #r2kHeader .h-inner{max-width:1200px;margin:0 auto;padding:14px 20px;display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:16px;position:relative}
    #r2kHeader .brand{display:flex;align-items:center;gap:10px;text-decoration:none}
    #r2kHeader .brand .logo{width:40px;height:40px;border-radius:50%;object-fit:cover;box-shadow:0 0 12px rgba(19,152,255,.35)}
    #r2kHeader .brand .name{font-size:22px;font-weight:800;color:#fff}
    #r2kHeader .brand .name .accent{color:var(--blue);text-shadow:0 0 10px rgba(19,152,255,.5)}
    #r2kHeader .nav{display:flex;justify-content:center;gap:26px}
    #r2kHeader .nav a{color:#e8f4ff;background:none;border:0;cursor:pointer;text-decoration:none;font-weight:700;font-size:14px;opacity:.92;padding:8px 6px;border-radius:8px;transition:.18s}
    #r2kHeader .nav a:hover{color:#fff;text-shadow:0 0 10px rgba(19,152,255,.45)}
    #r2kHeader .nav a[aria-current="page"]{color:#fff;text-shadow:0 0 10px rgba(19,152,255,.6)}
    #r2kHeader .actions{display:flex;justify-content:flex-end;gap:12px}
    #r2kHeader .btn{display:inline-flex;align-items:center;gap:8px;font-weight:800;font-size:14px;padding:10px 16px;border-radius:999px;text-decoration:none;border:1px solid rgba(19,152,255,.25);color:#0a1626;background:linear-gradient(90deg,#22b1ff,#1398ff);box-shadow:0 6px 20px rgba(19,152,255,.35),inset 0 0 10px rgba(255,255,255,.08);transition:transform .15s,box-shadow .15s,filter .15s}
    #r2kHeader .btn:hover{transform:translateY(-1px);filter:brightness(1.08);box-shadow:0 8px 26px rgba(19,152,255,.5)}
    #r2kHeader .hamburger{display:none;justify-self:end;cursor:pointer}
    #r2kHeader .hamburger span{display:block;width:24px;height:3px;margin:4px 0;background:#e8f4ff;border-radius:2px}
    #r2kHeader::after{content:"";position:absolute;left:0;right:0;bottom:-4px;height:2px;background:linear-gradient(90deg,rgba(0,0,0,0) 0%,rgba(19,152,255,.45) 20%,rgba(19,152,255,.9) 50%,rgba(19,152,255,.45) 80%,rgba(0,0,0,0) 100%);box-shadow:0 0 18px rgba(19,152,255,.4);pointer-events:none;z-index:100}
    @media (max-width:900px){
      #r2kHeader .h-inner{grid-template-columns:1fr auto auto}
      #r2kHeader .nav{display:none;position:absolute;top:60px;left:0;right:0;background:#080f19;border-top:1px solid rgba(19,152,255,.15);padding:12px 20px;gap:16px;flex-direction:column}
      #r2kHeader .nav.show{display:flex}
      #r2kHeader .hamburger{display:flex}
      #r2kHeader .actions{display:none}
    }

    /* ===== Background elements to match leaderboard page ===== */
    #particleCanvas{position:fixed;inset:0;z-index:-2}
    .glow-container{pointer-events:none;position:fixed;inset:0;z-index:-1}
    .left-glow,.right-glow{
      position:absolute;top:0;bottom:0;width:40%;
      filter:blur(70px);opacity:.25;
      background:radial-gradient(closest-side, rgba(19,152,255,.35), transparent 70%);
    }
    .left-glow{left:-10%}
    .right-glow{right:-10%}

    /* ===== Page layout & components ===== */
    .wrap{max-width:1200px;margin:0 auto;padding:24px 20px}
    .hero-title{font-weight:900;font-size:42px;text-align:center;margin-top:18px}
    .hero-sub{font-size:14px;color:var(--muted);text-align:center;margin-top:6px}
    .accent{color:#a99dff}

    .tabs{display:flex;gap:10px;justify-content:center;margin-top:18px}
    .tab-btn{border:1px solid var(--border);background:#0c1320;color:#e9f5ff;padding:10px 16px;border-radius:999px;font-weight:800;cursor:pointer;opacity:.9}
    .tab-btn.active{background:linear-gradient(90deg,#22b1ff,#1398ff);color:#08111a;border-color:#0f5da1;opacity:1}
    .tab-panel{display:none;margin-top:22px}
    .tab-panel.active{display:block}

    .grid{display:grid;grid-template-columns:1fr 1fr;gap:24px;margin-top:10px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:18px;
      padding:20px;
      box-shadow:0 0 24px rgba(107,92,255,.07);
    }
    .card-glow{position:relative;overflow:hidden}
    .card-glow::before{
      content:"";
      position:absolute;inset:-2px;
      background:radial-gradient(120px 120px at 70px 70px, rgba(125,107,255,.15), transparent 60%),
                 radial-gradient(140px 140px at 85% 20%, rgba(19,152,255,.10), transparent 60%);
      pointer-events:none;
    }

    .prize{font-size:46px;font-weight:900;text-shadow:0 0 14px rgba(255,255,255,.25);text-align:center;margin-top:6px}
    .prize-label{text-align:center;color:var(--muted);font-weight:800;letter-spacing:.08em;margin-top:6px}

    .pill-row{display:grid;grid-template-columns:1fr 1fr;gap:18px;margin-top:18px}
    .pill{background:#0c1320;border:1px solid var(--border);border-radius:12px;padding:14px;text-align:center}
    .pill .big{font-weight:900}
    .pill .cap{font-size:12px;color:var(--muted);margin-top:4px}

    .stat{background:#0c1320;border:1px solid var(--border);border-radius:12px;padding:14px;text-align:center;margin-top:18px}
    .stat .count{font-weight:900}

    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:10px;
      width:100%; padding:14px 16px; border-radius:12px; margin-top:18px;
      border:1px solid #2b2466; background:rgba(107,92,255,.1); color:#f0eaff; font-weight:800; cursor:pointer;
      transition:.18s; text-decoration:none;
    }
    .btn:hover{filter:brightness(1.07);box-shadow:0 0 18px rgba(107,92,255,.25) inset}
    .btn.alt{border-color:#0f5da1;background:linear-gradient(90deg,#22b1ff,#1398ff);color:#08111a;box-shadow:0 6px 20px rgba(19,152,255,.35)}

    .progress{margin-top:14px}
    .bar{height:12px;background:#081321;border:1px solid var(--border);border-radius:999px;overflow:hidden}
    .fill{height:100%;width:0;background:linear-gradient(90deg,#1398ff,#48c7ff);box-shadow:0 0 12px rgba(0,153,255,.55);transition:width .8s ease}
    .meta{display:flex;justify-content:space-between;font-size:12px;color:var(--muted);margin-top:6px}
    .meta .strong{color:#fff;font-weight:800}

    .tick-icon{
      display:inline-flex;align-items:center;justify-content:center;
      width:60px;height:60px;border-radius:16px;
      background:radial-gradient(60px 60px at 50% 50%, rgba(125,107,255,.22), rgba(125,107,255,.08));
      box-shadow:0 4px 30px rgba(125,107,255,.3) inset, 0 0 20px rgba(125,107,255,.15);
      margin:0 auto 6px;
    }
    .tick-icon svg{width:30px;height:30px;opacity:.95}

    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:3000}
    .modal .sheet{background:var(--card);border:1px solid var(--border);border-radius:14px;max-width:600px;width:92%;padding:18px}
    .list{max-height:340px;overflow:auto;border:1px dashed var(--border);border-radius:10px;margin-top:10px}
    .list-item{display:flex;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #0f1c2c}
    .list-item:nth-child(odd){background:#0a131f}
    .close-x{background:transparent;border:1px solid var(--border);padding:8px 12px;border-radius:10px;color:#cfe9ff;cursor:pointer}

    /* Winners table */
    .winners{width:100%;border-collapse:collapse;margin-top:10px}
    .winners th,.winners td{border:1px solid var(--border);padding:10px 12px;text-align:left}
    .winners th{background:#0c1320;color:#e9f5ff}
    .winners tr:nth-child(odd){background:#0a131f}
  </style>
</head>
<body>
  <!-- Background (matches leaderboard) -->
  <canvas id="particleCanvas"></canvas>
  <div class="glow-container"><div class="left-glow"></div><div class="right-glow"></div></div>

  <!-- Header -->
  <header id="r2kHeader">
    <div class="h-inner">
      <a href="/" class="brand" aria-label="R2K2 Home">
        <img src="/assets/logo.png" class="logo" alt="R2K2">
        <div class="name">R2K<span class="accent">2</span></div>
      </a>

      <nav class="nav" id="r2kNav">
        <a href="/">Home</a>
        <a href="/leaderboard/rainbet">Leaderboard</a>
        <a href="/raffle" aria-current="page">Raffle</a>
        <a href="/challenges">Challenges</a>
      </nav>

      <div class="actions">
        <a class="btn" href="https://rainbet.com/?r=r2k2" target="_blank" rel="noopener">Join Rainbet</a>
      </div>

      <div class="hamburger" id="hamburger" aria-label="Menu" aria-controls="r2kNav" aria-expanded="false">
        <span></span><span></span><span></span>
      </div>
    </div>
  </header>

  <main class="wrap">
    <h1 class="hero-title"><span class="accent">Active</span> Raffles</h1>
    <p class="hero-sub">Wager to automatically enter and win prizes. One ticket per eligible entrant ‚Äî fair and simple.</p>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab-btn active" data-tab="weekly">Weekly</button>
      <button class="tab-btn" data-tab="monthly">Monthly</button>
      <button class="tab-btn" data-tab="winners">Previous Winners</button>
    </div>

    <!-- WEEKLY -->
    <section class="tab-panel active" id="panel-weekly">
      <div class="grid">
        <article class="card card-glow">
          <div class="tick-icon">
            <svg viewBox="0 0 24 24" fill="#ffffff"><path d="M20 12v8a2 2 0 0 1-2 2h-5v-10h7zm-9 10H6a2 2 0 0 1-2-2v-8h7v10zM4 9h16v2H4V9zm4-7a3 3 0 0 1 3 3v1h-1a3 3 0 0 1-2-5zm8 0a3 3 0 0 1-2 5h-1V5a3 3 0 0 1 3-3z"/></svg>
          </div>
          <div class="prize" id="w-amount">$25.00</div>
          <div class="prize-label">WEEKLY CASH ‚Äî 1 winner</div>

          <div class="pill-row">
            <div class="pill">
              <div class="big" id="w-min">$250.00</div>
              <div class="cap">Min Wager (7-day window)</div>
            </div>
            <div class="pill">
              <div class="big" id="w-remaining">--</div>
              <div class="cap">Remaining (CST)</div>
            </div>
          </div>

          <div class="stat">
            <div class="count" id="w-participants">0</div>
            <div class="cap">Eligible Participants</div>
          </div>

          <div class="progress">
            <div class="bar"><div class="fill" id="w-fill" style="width:0%"></div></div>
            <div class="meta"><span id="w-pct">0%</span><span id="w-meta">0 / 0</span></div>
          </div>

          <button class="btn" id="w-view">üë• View Participants</button>
          <a class="btn alt" href="https://rainbet.com/?r=r2k2" target="_blank" rel="noopener">Join Rainbet</a>
        </article>
      </div>
      <p class="hero-sub">Eligibility resets every 7 days. Auto-draw runs at the end of the window.</p>
    </section>

    <!-- MONTHLY -->
    <section class="tab-panel" id="panel-monthly">
      <div class="grid">
        <article class="card card-glow">
          <div class="tick-icon">
            <svg viewBox="0 0 24 24" fill="#ffffff"><path d="M20 12v8a2 2 0 0 1-2 2h-5v-10h7zm-9 10H6a2 2 0 0 1-2-2v-8h7v10zM4 9h16v2H4V9zm4-7a3 3 0 0 1 3 3v1h-1a3 3 0 0 1-2-5zm8 0a3 3 0 0 1-2 5h-1V5a3 3 0 0 1 3-3z"/></svg>
          </div>
          <div class="prize" id="m-amount">$100.00</div>
          <div class="prize-label">MONTHLY CASH ‚Äî 1 winner</div>

          <div class="pill-row">
            <div class="pill">
              <div class="big" id="m-min">$5,000.00</div>
              <div class="cap">Min Wager (30-day window)</div>
            </div>
            <div class="pill">
              <div class="big" id="m-remaining">--</div>
              <div class="cap">Remaining (CST)</div>
            </div>
          </div>

          <div class="stat">
            <div class="count" id="m-participants">0</div>
            <div class="cap">Eligible Participants</div>
          </div>

          <div class="progress">
            <div class="bar"><div class="fill" id="m-fill" style="width:0%"></div></div>
            <div class="meta"><span id="m-pct">0%</span><span id="m-meta">0 / 0</span></div>
          </div>

          <button class="btn" id="m-view">üë• View Participants</button>
          <a class="btn alt" href="https://rainbet.com/?r=r2k2" target="_blank" rel="noopener">Join Rainbet</a>
        </article>
      </div>
      <p class="hero-sub">One entry per eligible user. Auto-draw runs when the 30-day window ends.</p>
    </section>

    <!-- PREVIOUS WINNERS -->
    <section class="tab-panel" id="panel-winners">
      <article class="card card-glow">
        <h3 style="margin:0 0 8px 0;">Previous Winners</h3>
        <p class="hero-sub" style="margin-top:0">Auto-logged on draw (API-backed; falls back to localStorage if offline).</p>
        <table class="winners" id="winnersTable">
          <thead>
            <tr>
              <th>Date</th>
              <th>Raffle</th>
              <th>Winner</th>
              <th>Prize</th>
              <th>TX / Note</th>
            </tr>
          </thead>
          <tbody id="winnersBody">
            <!-- rows injected -->
          </tbody>
        </table>
      </article>
    </section>
  </main>

  <!-- Participants Modal -->
  <div class="modal" id="participantsModal" aria-hidden="true">
    <div class="sheet">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">Participants</h3>
        <button class="close-x" id="closeModal">Close</button>
      </div>
      <div class="list" id="participantsList"></div>
    </div>
  </div>

  <!-- JS deps you already use on leaderboard for background effects -->
  <script src="/js/particles.js"></script>

  <script>
    /* ========= CONFIG: API ROUTES =========
       You said: paste-ready with API. These are the endpoints the page will call.

       GET  /api/raffle/config
           -> { weekly:{min_wager, prize_usd, start_at, end_at}, monthly:{...} }

       GET  /api/raffle/participants?kind=weekly|monthly
           -> { participants: [{username:"Name"}, ...] }

       POST /api/raffle/draw { kind:"weekly"|"monthly" }
           -> { winner:{username:"..."}, prize_usd: number, drawn_at: ISOString }

       GET  /api/raffle/winners
           -> { winners: [{date:"YYYY-MM-DD", kind:"weekly"|"monthly", winner:"username", prize_usd:number, note?:string}], }

       (All GETs cache: no-store)
       The page gracefully falls back to localStorage if endpoints fail.
    */
    const API = {
      config: '/api/raffle/config',
      participants: kind => `/api/raffle/participants?kind=${encodeURIComponent(kind)}`,
      draw: '/api/raffle/draw',
      winners: '/api/raffle/winners'
    };

    /* ===== Mobile menu ===== */
    (function(){
      const burger=document.getElementById('hamburger');
      const nav=document.getElementById('r2kNav');
      if(burger&&nav){
        burger.addEventListener('click',()=>{
          const open = nav.classList.toggle('show');
          burger.setAttribute('aria-expanded', String(open));
        });
      }
    })();

    /* ===== Particles background (matches leaderboard) ===== */
    (function initParticles(){
      if(typeof window.initR2KParticles === 'function'){
        // If your /js/particles.js exposes a helper, call it:
        window.initR2KParticles('particleCanvas');
      }else{
        // Minimal fallback swirl if your helper isn't present
        const c = document.getElementById('particleCanvas');
        if(!c) return;
        const ctx = c.getContext('2d');
        let w,h,ts=0; function resize(){w= c.width = innerWidth; h = c.height = innerHeight;}
        addEventListener('resize', resize); resize();
        const dots = Array.from({length:90},()=>({
          x: Math.random()*w, y: Math.random()*h,
          vx:(Math.random()-0.5)*0.3, vy:(Math.random()-0.5)*0.3, r:Math.random()*1.8+0.4
        }));
        (function loop(){
          ts+=0.016; ctx.clearRect(0,0,w,h);
          for(const d of dots){
            d.x=(d.x+d.vx+w)%w; d.y=(d.y+d.vy+h)%h;
            ctx.beginPath(); ctx.arc(d.x,d.y,d.r,0,Math.PI*2);
            ctx.fillStyle = `rgba(19,152,255,${0.25+0.25*Math.sin(ts+d.x*0.001+d.y*0.001)})`;
            ctx.fill();
          }
          requestAnimationFrame(loop);
        })();
      }
    })();

    /* ===== Tabs ===== */
    const $ = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);
    $$('.tab-btn').forEach(btn=>{
      btn.addEventListener('click',()=>{
        $$('.tab-btn').forEach(b=>b.classList.remove('active'));
        $$('.tab-panel').forEach(p=>p.classList.remove('active'));
        btn.classList.add('active');
        $('#panel-'+btn.dataset.tab).classList.add('active');
      });
    });

    /* ===== State ===== */
    const FALLBACK = {
      weekly: { prizeUSD: 25, minWager: 250, startAt: Date.now(), endAt: Date.now()+7*24*3600*1000 },
      monthly:{ prizeUSD:100, minWager:5000, startAt: Date.now(), endAt: Date.now()+30*24*3600*1000 },
      winners:[]
    };
    const STATE = {
      weekly: {...FALLBACK.weekly},
      monthly:{...FALLBACK.monthly},
      winners: JSON.parse(localStorage.getItem('r2k2_raffle_winners')||'[]'),
      participants: { weekly:[], monthly:[] }
    };

    function saveLocalWinners(){
      localStorage.setItem('r2k2_raffle_winners', JSON.stringify(STATE.winners));
    }

    /* ===== API helpers with graceful fallback ===== */
    async function apiJSON(url, opts){
      const res = await fetch(url, { cache:'no-store', ...opts });
      if(!res.ok) throw new Error(`${res.status} ${res.statusText}`);
      return res.json();
    }

    async function loadConfig(){
      try{
        const data = await apiJSON(API.config);
        if(data?.weekly){ STATE.weekly = {
          prizeUSD: Number(data.weekly.prize_usd)||25,
          minWager: Number(data.weekly.min_wager)||250,
          startAt: new Date(data.weekly.start_at).getTime() || Date.now(),
          endAt: new Date(data.weekly.end_at).getTime() || Date.now()+7*24*3600*1000
        }; }
        if(data?.monthly){ STATE.monthly = {
          prizeUSD: Number(data.monthly.prize_usd)||100,
          minWager: Number(data.monthly.min_wager)||5000,
          startAt: new Date(data.monthly.start_at).getTime() || Date.now(),
          endAt: new Date(data.monthly.end_at).getTime() || Date.now()+30*24*3600*1000
        }; }
      }catch(e){
        // use fallback already seeded
        console.warn('Config API failed, using fallback', e);
      }
    }

    async function loadParticipants(kind){
      try{
        const data = await apiJSON(API.participants(kind));
        STATE.participants[kind] = Array.isArray(data?.participants) ? data.participants : [];
      }catch(e){
        console.warn('Participants API failed, using demo names', e);
        // small demo pool so UI isn't empty
        const n = kind==='weekly' ? 18 : 9;
        STATE.participants[kind] = Array.from({length:n},(_,i)=>({username:`${kind}_User_${i+1}`}));
      }
    }

    async function loadWinners(){
      try{
        const data = await apiJSON(API.winners);
        STATE.winners = Array.isArray(data?.winners)? data.winners : STATE.winners;
      }catch(e){
        console.warn('Winners API failed, using localStorage', e);
        // keep local winners
      }
    }

    async function postDraw(kind){
      try{
        const data = await apiJSON(API.draw, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ kind })
        });
        // Expect: { winner:{username}, prize_usd, drawn_at }
        const when = data?.drawn_at ? new Date(data.drawn_at) : new Date();
        const label = `${String(when.getMonth()+1).padStart(2,'0')}-${String(when.getDate()).padStart(2,'0')}`;
        const row = {
          date: label,
          kind,
          winner: data?.winner?.username || 'Unknown',
          prize_usd: Number(data?.prize_usd)|| (kind==='weekly'?STATE.weekly.prizeUSD:STATE.monthly.prizeUSD),
          note: data?.note || '-'
        };
        // Prepend and repaint
        STATE.winners.unshift(row);
        saveLocalWinners();
        paintWinners();
        // Reload config to get next window times (server should advance windows)
        await loadConfig();
      }catch(e){
        console.warn('Draw API failed; skipping draw', e);
      }
    }

    /* ===== UI helpers ===== */
    const UI = {
      weekly: {
        remaining: $('#w-remaining'),
        participants: $('#w-participants'),
        fill: $('#w-fill'), pct: $('#w-pct'), meta: $('#w-meta'),
        viewBtn: $('#w-view')
      },
      monthly: {
        remaining: $('#m-remaining'),
        participants: $('#m-participants'),
        fill: $('#m-fill'), pct: $('#m-pct'), meta: $('#m-meta'),
        viewBtn: $('#m-view')
      },
      modal: {
        el: $('#participantsModal'),
        list: $('#participantsList'),
        close: $('#closeModal')
      }
    };

    const money = n => Number(n).toLocaleString(undefined,{style:'currency',currency:'USD',maximumFractionDigits:2});
    function timeLeft(msEnd){
      const s = Math.max(0, Math.floor((msEnd - Date.now())/1000));
      const d = Math.floor(s/86400), h = Math.floor((s%86400)/3600), m = Math.floor((s%3600)/60);
      return d>0 ? `${d}d ${h}h` : `${h}h ${m}m`;
    }
    function setFill(prefix, current, goal){
      const pct = Math.max(0, Math.min(100, goal ? (current/goal)*100 : 0));
      $('#'+prefix+'-fill').style.width = pct + '%';
      $('#'+prefix+'-pct').textContent = Math.round(pct) + '%';
      $('#'+prefix+'-meta').textContent = `${current} / ${goal}`;
    }

    function paintPanels(){
      const w = STATE.weekly, m = STATE.monthly;
      UI.weekly.remaining.textContent = timeLeft(w.endAt);
      UI.monthly.remaining.textContent = timeLeft(m.endAt);
      UI.weekly.participants.textContent = STATE.participants.weekly.length;
      UI.monthly.participants.textContent = STATE.participants.monthly.length;

      // Visual progress (participants vs friendly goals)
      setFill('w', STATE.participants.weekly.length, 50);
      setFill('m', STATE.participants.monthly.length, 100);

      // Ensure amounts and mins show correct values
      $('#w-amount').textContent = money(w.prizeUSD);
      $('#w-min').textContent = money(w.minWager);
      $('#m-amount').textContent = money(m.prizeUSD);
      $('#m-min').textContent = money(m.minWager);
    }

    function paintWinners(){
      const tbody = $('#winnersBody');
      if(!STATE.winners.length){
        tbody.innerHTML = `<tr><td colspan="5" style="color:#a6c9ef">No winners recorded yet.</td></tr>`;
        return;
      }
      tbody.innerHTML = STATE.winners.map(w=>{
        const raffle = w.kind==='weekly' ? 'Weekly' : 'Monthly';
        const name = (w.winner || w.name || '').toString().replace(/[<>]/g,'');
        const prize = money(w.prize_usd ?? w.prizeUSD ?? 0);
        return `<tr>
          <td>${w.date}</td>
          <td>${raffle}</td>
          <td>${name}</td>
          <td>${prize}</td>
          <td>${w.note || '-'}</td>
        </tr>`;
      }).join('');
    }

    /* ===== Participants modal ===== */
    UI.modal.close.addEventListener('click', ()=>{ UI.modal.el.style.display='none'; UI.modal.el.setAttribute('aria-hidden','true'); });
    function openParticipants(kind){
      const rows = (STATE.participants[kind]||[]).map(p=>{
        const name = (p.username||p.name||'Unknown').toString().replace(/[<>]/g,'');
        return `<div class="list-item"><span>${name}</span><span>üéüÔ∏è 1</span></div>`;
      }).join('');
      UI.modal.list.innerHTML = rows || `<div class="list-item"><span>No entries yet.</span><span></span></div>`;
      UI.modal.el.style.display='flex';
      UI.modal.el.setAttribute('aria-hidden','false');
    }
    UI.weekly.viewBtn.onclick  = ()=>openParticipants('weekly');
    UI.monthly.viewBtn.onclick = ()=>openParticipants('monthly');

    /* ===== Auto-draw loop =====
       IMPORTANT: We call the SERVER to draw so it‚Äôs provable and logged.
       If server is down, we simply skip until next tick (no client-side draws).
    */
    function tickDraws(){
      const now = Date.now();
      if(now >= STATE.weekly.endAt){
        postDraw('weekly').then(()=> {
          // After draw, reload participants for the new window
          loadParticipants('weekly').then(paintPanels);
        });
      }
      if(now >= STATE.monthly.endAt){
        postDraw('monthly').then(()=> {
          loadParticipants('monthly').then(paintPanels);
        });
      }
    }

    /* ===== Boot ===== */
    (async function boot(){
      await loadConfig();
      await Promise.all([loadParticipants('weekly'), loadParticipants('monthly'), loadWinners()]);
      paintPanels();
      paintWinners();

      // Timers
      setInterval(()=>{ paintPanels(); tickDraws(); }, 1000 * 30); // update + try draw every 30s
    })();
  </script>
</body>
</html>