<!DOCTYPE html>
<html lang="en">
<head>
  <title>R2K2 | Active Raffles</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Active raffles for the R2K2 community. Wager to enter and win!" />
  <meta property="og:image" content="/assets/logo.png" />
  <link rel="icon" type="image/png" href="/assets/logo.png" />

  <!-- Keep your site CSS exactly as-is -->
  <link rel="stylesheet" href="/css/app.css" />
  <link rel="stylesheet" href="/css/vendor.css" />
  <link rel="stylesheet" href="/css/toast.css" />

  <style>
    :root{
      --bg-deep:#070b12;
      --card:#0b0f17;
      --border:#1b2a40;
      --ink:#e9f5ff;
      --muted:#a6c9ef;
      --blue:#1398ff;
      --purple:#6b5cff;
    }
    html,body{background:var(--bg-deep);color:var(--ink);margin:0}

    /* ===== Header ===== */
    #r2kHeader{
      position:sticky; top:0; z-index:2000;
      background:linear-gradient(180deg, rgba(7,10,16,0.98) 0%, rgba(5,8,13,0.98) 85%, rgba(3,5,9,1) 100%);
      backdrop-filter:blur(6px);
      border:none !important;
      box-shadow:0 4px 12px rgba(0,0,0,.4);
    }
    /* brand | NAV (flex) | actions */
    #r2kHeader .h-inner{
      max-width:1200px;
      margin:0 auto;
      padding:30px 20px;
      display:grid;
      grid-template-columns:auto 1fr auto;
      align-items:center;
      gap:16px;
    }
    #r2kHeader .brand{display:flex;align-items:center;gap:10px;text-decoration:none}
    #r2kHeader .brand .logo{width:40px;height:40px;border-radius:50%;object-fit:cover;box-shadow:0 0 12px rgba(19,152,255,.35)}
    #r2kHeader .brand .name{font-size:22px;font-weight:800;color:#fff}
    #r2kHeader .brand .name .accent{color:var(--blue);text-shadow:0 0 10px rgba(19,152,255,.5)}

    /* Nav fits inside header */
    #r2kHeader .nav{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:22px;               /* slightly tighter */
      flex-wrap:nowrap;       /* keep a single row on desktop */
      min-width:0;            /* allow flex shrink */
    }
    #r2kHeader .nav a, #r2kHeader .nav button{
      color:#e8f4ff;background:none;border:0;cursor:pointer;text-decoration:none;
      font-weight:700;font-size:clamp(12px,1.4vw,14px); /* gentle scale down on tighter widths */
      opacity:.92;padding:8px 6px;border-radius:8px;transition:.18s;
      white-space:nowrap;      /* prevent wrapping of each item */
    }
    #r2kHeader .nav a:hover, #r2kHeader .nav button:hover{color:#fff;text-shadow:0 0 10px rgba(19,152,255,.45)}

    #r2kHeader .actions{display:flex;justify-content:flex-end;gap:12px}
    #r2kHeader .btn{
      display:inline-flex;align-items:center;gap:8px;font-weight:800;font-size:14px;
      padding:10px 16px;border-radius:999px;text-decoration:none;border:1px solid rgba(19,152,255,.25);
      color:#0a1626;background:linear-gradient(90deg,#22b1ff,#1398ff);
      box-shadow:0 6px 20px rgba(19,152,255,.35),inset 0 0 10px rgba(255,255,255,.08);
      transition:transform .15s,box-shadow .15s,filter .15s
    }
    #r2kHeader .btn:hover{transform:translateY(-1px);filter:brightness(1.08);box-shadow:0 8px 26px rgba(19,152,255,.5)}
    #r2kHeader .btn.outline{background:transparent;color:#e8f4ff;border-color:rgba(19,152,255,.45);box-shadow:0 0 16px rgba(19,152,255,.25) inset}
    #r2kHeader .btn.outline:hover{background:rgba(19,152,255,.08);color:#fff}

    #r2kHeader .hamburger{display:none;justify-self:end;cursor:pointer}
    #r2kHeader .hamburger{display:none; flex-direction:column; align-items:center; justify-content:center; gap:6px}
    #r2kHeader .hamburger span{display:block;width:26px;height:3px;background:#e8f4ff;border-radius:2px}

    #r2kHeader::after{
      content:"";position:absolute;left:0;right:0;bottom:-4px;height:2px;
      background:linear-gradient(90deg,rgba(0,0,0,0) 0%,rgba(19,152,255,.45) 20%,rgba(19,152,255,.9) 50%,rgba(19,152,255,.45) 80%,rgba(0,0,0,0) 100%);
      box-shadow:0 0 18px rgba(19,152,255,.4);pointer-events:none;z-index:100
    }

    /* Tighten gaps a bit earlier so tabs donâ€™t wrap before hamburger */
    @media (max-width:1100px){
      #r2kHeader .nav{ gap:16px; }
    }

    @media (max-width:900px){
      #r2kHeader .h-inner{grid-template-columns:auto auto auto}
      #r2kHeader .nav{
        display:none;position:absolute;top:60px;left:0;right:0;background:#080f19;
        border-top:1px solid rgba(19,152,255,.15);padding:12px 20px;gap:16px;flex-direction:column
      }
      #r2kHeader .nav.show{display:flex}
      #r2kHeader .hamburger{display:flex}
      #r2kHeader .actions{display:none}
    }

    /* ===== Page layout & tabs ===== */
    .wrap{max-width:1200px;margin:0 auto;padding:24px 20px}
    .hero-title{font-weight:900;font-size:42px;text-align:center;margin-top:18px}
    .hero-sub{font-size:14px;color:var(--muted);text-align:center;margin-top:6px}

    .tabs{display:flex;justify-content:center;gap:10px;margin-top:20px;flex-wrap:wrap}
    .tab-btn{
      background:#0c1320;border:1px solid var(--border);color:#cfe9ff;
      padding:10px 14px;border-radius:999px;font-weight:800;cursor:pointer;transition:.15s
    }
    .tab-btn.active{background:linear-gradient(90deg,#22b1ff,#1398ff);color:#08111a;border-color:#0f5da1}
    .panel{display:none;margin-top:24px}
    .panel.active{display:block}

    /* ===== Cards (centered grid) ===== */
    .grid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 520px));
      justify-content:center;      /* center the columns */
      gap:24px;
      margin-top:8px;
    }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:18px;
      padding:20px;
      box-shadow:0 0 24px rgba(107,92,255,.07);
      width:100%;
      max-width:520px;             /* keep each card from stretching too wide */
      margin:0 auto;
    }
    .prize{font-size:46px;font-weight:900;text-align:center;margin-top:6px}
    .prize-label{text-align:center;color:var(--muted);font-weight:800;letter-spacing:.08em;margin-top:6px}
    .pill-row{display:grid;grid-template-columns:1fr 1fr;gap:18px;margin-top:18px}
    @media (max-width:520px){.pill-row{grid-template-columns:1fr}}
    .pill{background:#0c1320;border:1px solid var(--border);border-radius:12px;padding:14px;text-align:center}
    .pill .big{font-weight:900}
    .pill .cap{font-size:12px;color:var(--muted);margin-top:4px}
    .stat{background:#0c1320;border:1px solid var(--border);border-radius:12px;padding:14px;text-align:center;margin-top:18px}
    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:10px;
      width:100%; padding:14px 16px; border-radius:12px; margin-top:18px;
      border:1px solid #2b2466; background:rgba(107,92,255,.1); color:#f0eaff; font-weight:800; cursor:pointer;
      transition:.18s;
    }
    .btn:hover{filter:brightness(1.07);box-shadow:0 0 18px rgba(107,92,255,.25) inset}
    .btn.alt{border-color:#0f5da1;background:linear-gradient(90deg,#22b1ff,#1398ff);color:#08111a;box-shadow:0 6px 20px rgba(19,152,255,.35)}

    .bar{height:12px;background:#081321;border:1px solid var(--border);border-radius:999px;overflow:hidden}
    .fill{height:100%;width:0;background:linear-gradient(90deg,#1398ff,#48c7ff);box-shadow:0 0 12px rgba(0,153,255,.55);transition:width .8s ease}
    .meta{display:flex;justify-content:space-between;font-size:12px;color:var(--muted);margin-top:6px}
    .meta .strong{color:#fff;font-weight:800}

    /* Draw modal + spinner */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:3000}
    .modal .sheet{background:var(--card);border:1px solid var(--border);border-radius:14px;max-width:640px;width:92%;padding:18px}
    .close-x{background:transparent;border:1px solid var(--border);padding:8px 12px;border-radius:10px;color:#cfe9ff;cursor:pointer}
    .roller{margin:16px auto 8px;height:48px;overflow:hidden;border:1px solid var(--border);border-radius:10px;background:#0a101a}
    .roller .strip{display:flex;flex-direction:column;gap:6px;padding:10px;transform:translateY(0);transition:transform 2.2s cubic-bezier(.2,.7,0,1)}
    .strip .name{line-height:28px;text-align:center;font-weight:800}

    /* Winners table */
    table.wins{width:100%;border-collapse:collapse;margin-top:10px;font-size:14px}
    .wins th,.wins td{border-bottom:1px solid #0f1c2c;padding:10px 8px;text-align:left}
    .wins th{color:#cfe9ff;font-weight:900}
  </style>
</head>
<body>
  <!-- Header -->
  <header id="r2kHeader">
    <div class="h-inner">
      <a href="/" class="brand" aria-label="R2K2 Home">
        <img src="/assets/logo.png" class="logo" alt="R2K2">
        <div class="name">R2K<span class="accent">2</span></div>
      </a>

      <nav class="nav" id="r2kNav">
        <a href="/">Home</a>
        <a href="/leaderboard/rainbet">Leaderboard</a>
        <a href="/raffle" aria-current="page">Raffle</a>
        <a href="/challenges">Challenges</a>
      </nav>

      <div class="actions">
        <a class="btn outline" href="/register">Register</a>
        <a class="btn" href="https://rainbet.com/?r=r2k2" target="_blank" rel="noopener">Join Rainbet</a>
      </div>

      <div class="hamburger" id="hamburger" aria-label="Menu" aria-controls="r2kNav" aria-expanded="false">
        <span></span><span></span><span></span>
      </div>
    </div>
  </header>

  <main class="wrap">
    <h1 class="hero-title">R2K2 <span style="color:var(--blue);text-shadow:0 0 10px rgba(19,152,255,.45)">Raffles</span></h1>
    <p class="hero-sub">One ticket per qualified entrant. Draws run automatically. Good luck! âœ¨</p>

    <div class="tabs">
      <button class="tab-btn active" data-tab="weekly">Weekly</button>
      <button class="tab-btn" data-tab="monthly">Monthly</button>
      <button class="tab-btn" data-tab="previous">Previous Winners</button>
    </div>

    <!-- WEEKLY -->
    <section class="panel active" id="panel-weekly">
      <div class="grid">
        <article class="card">
          <div class="prize" id="w-prize">$25.00</div>
          <div class="prize-label">WEEKLY CASH â€¢ 1 WINNER</div>

          <div class="pill-row">
            <div class="pill">
              <div class="big" id="w-min">$250.00</div>
              <div class="cap">Min Wager (7 days)</div>
            </div>
            <div class="pill">
              <div class="big" id="w-remaining">--</div>
              <div class="cap">Remaining (CST)</div>
            </div>
          </div>

          <div class="stat">
            <div class="count" id="w-participants">0</div>
            <div class="cap">Qualified Entrants</div>
          </div>

          <div class="meta" style="margin-top:10px">
            <span>Window:</span>
            <span id="w-window">â€”</span>
          </div>

          <button class="btn alt" id="w-view">ðŸ‘¥ View Entrants</button>
          <button class="btn" id="w-force">ðŸŽ¬ Force Draw (admin)</button>
        </article>
      </div>
    </section>

    <!-- MONTHLY -->
    <section class="panel" id="panel-monthly">
      <div class="grid">
        <article class="card">
          <div class="prize" id="m-prize">$100.00</div>
          <div class="prize-label">MONTHLY CASH â€¢ 1 WINNER</div>

          <div class="pill-row">
            <div class="pill">
              <div class="big" id="m-min">$5,000.00</div>
              <div class="cap">Min Wager (30 days)</div>
            </div>
            <div class="pill">
              <div class="big" id="m-remaining">--</div>
              <div class="cap">Remaining (CST)</div>
            </div>
          </div>

          <div class="stat">
            <div class="count" id="m-participants">0</div>
            <div class="cap">Qualified Entrants</div>
          </div>

          <div class="meta" style="margin-top:10px">
            <span>Window:</span>
            <span id="m-window">â€”</span>
          </div>

          <button class="btn alt" id="m-view">ðŸ‘¥ View Entrants</button>
          <button class="btn" id="m-force">ðŸŽ¬ Force Draw (admin)</button>
        </article>
      </div>
    </section>

    <!-- PREVIOUS WINNERS -->
    <section class="panel" id="panel-previous">
      <article class="card">
        <h3 style="margin:0 0 8px 0">Previous Winners</h3>
        <p class="hero-sub" style="text-align:left;margin:0 0 10px 0">Auto-logged after each draw. Server entries shown first.</p>
        <table class="wins" id="wins-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Raffle</th>
              <th>Winner</th>
              <th>Prize</th>
              <th>Entries</th>
              <th>Tx</th>
            </tr>
          </thead>
          <tbody id="wins-body">
            <tr><td colspan="6" style="padding:14px 8px;color:#a6c9ef">Loadingâ€¦</td></tr>
          </tbody>
        </table>
      </article>
    </section>
  </main>

  <!-- Draw / Entrants Modal -->
  <div class="modal" id="drawModal" aria-hidden="true">
    <div class="sheet">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
        <h3 id="drawTitle" style="margin:0">Drawingâ€¦</h3>
        <button class="close-x" id="closeModal">Close</button>
      </div>

      <!-- roller -->
      <div class="roller" id="roller" style="display:none">
        <div class="strip" id="strip"></div>
      </div>

      <!-- entrants list -->
      <div id="entrantList" style="max-height:360px;overflow:auto;border:1px dashed var(--border);border-radius:10px;margin-top:10px;padding:8px 0"></div>

      <div id="winnerLine" style="margin-top:12px;font-weight:900;font-size:18px"></div>
    </div>
  </div>

  <!-- ====== JS ====== -->
  <script>
    /* ========== Mobile hamburger ========== */
    (function(){
      const burger=document.getElementById('hamburger');
      const nav=document.getElementById('r2kNav');
      if(burger&&nav){
        burger.addEventListener('click',()=>{
          const open = nav.classList.toggle('show');
          burger.setAttribute('aria-expanded', String(open));
        });
      }
    })();

    /* ==================== Config ==================== */
    const TZ = "America/Mexico_City"; // your local time
    const API_LB = "/api/leaderboard"; // existing endpoint
    const API_LOG = "/api/raffle/log"; // server log (we POST here)
    const API_WINS = "/api/raffle/winners?limit=50"; // optional server history

    const WEEKLY = { label:"Weekly", days:7,   min:250,  prize:25.00, key:"raffle_anchor_weekly"  };
    const MONTHLY= { label:"Monthly",days:30,  min:5000, prize:100.00,key:"raffle_anchor_monthly" };

    /* ================== Time helpers ================== */
    const fmtUsd = n=>n.toLocaleString(undefined,{style:'currency',currency:'USD',maximumFractionDigits:2});
    const pad2 = n => String(n).padStart(2,"0");
    const isoDate = d => d.toISOString().slice(0,10);

    function inTZ(date, tz=TZ){
      const parts = new Intl.DateTimeFormat('en-US', { timeZone: tz,
        year:'numeric', month:'2-digit', day:'2-digit',
        hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false
      }).formatToParts(date);
      const get = t => parts.find(p => p.type===t)?.value;
      return { y:+get('year'), m:+get('month'), d:+get('day'), hh:+get('hour'), mm:+get('minute'), ss:+get('second') };
    }

    // Rolling window from anchor (stored) with length days
    function windowFromAnchor(anchorISO, days){
      const start = new Date(anchorISO+"T00:00:00Z");
      const now = new Date();
      const len = days*86400000;
      const k = Math.floor((now - start)/len);
      const startK = new Date(start.getTime() + k*len);
      const endK   = new Date(startK.getTime() + len);
      return { start:startK, end:endK };
    }

    function humanWindow(start, end){
      const s = inTZ(start); const e = inTZ(end);
      return `${s.y}-${pad2(s.m)}-${pad2(s.d)} â†’ ${e.y}-${pad2(e.m)}-${pad2(e.d)}`;
    }

    function remaining(end){
      const ms = end.getTime() - Date.now();
      const S = Math.max(0, Math.floor(ms/1000));
      const d = Math.floor(S/86400), h = Math.floor((S%86400)/3600), m = Math.floor((S%3600)/60);
      if(d>0) return `${d}d ${h}h`;
      return `${h}h ${m}m`;
    }

    /* ============== Anchors (persisted) ============== */
    function getOrInitAnchor(key){
      let v = localStorage.getItem(key);
      if(!v){
        const now = inTZ(new Date());
        v = `${now.y}-${pad2(now.m)}-${pad2(now.d)}`;
        localStorage.setItem(key, v);
      }
      return v;
    }

    /* ============== Entrants (from leaderboard API) ============== */
    async function fetchEntrants(startISO,endISO,minUSD){
      const url = `${API_LB}?start_at=${encodeURIComponent(startISO)}&end_at=${encodeURIComponent(endISO)}`;
      const res = await fetch(url,{cache:"no-store"});
      if(!res.ok){
        const txt = await res.text().catch(()=> "");
        throw new Error(`Leaderboard API ${res.status}\n${txt.slice(0,200)}`);
      }
      const json = await res.json();
      const arr = Array.isArray(json) ? json : (json.affiliates || []);
      const byUser = new Map();
      for(const a of arr){
        const name = (a.username||"").trim();
        const amt = Number(a.wagered_amount ?? a.wagered ?? 0);
        if(!name) continue;
        const prev = byUser.get(name) || 0;
        byUser.set(name, prev + (Number.isFinite(amt)?amt:0));
      }
      const entrants = [];
      byUser.forEach((sum, name)=>{
        if(sum >= minUSD) entrants.push({ name, wagered: sum });
      });
      entrants.sort((a,b)=> b.wagered - a.wagered);
      return entrants;
    }

    /* ============== Crypto RNG selection ============== */
    function securePick(n){
      if(n<=1) return 0;
      const max = Math.floor(0x100000000 / n) * n;
      const buf = new Uint32Array(1);
      while(true){
        crypto.getRandomValues(buf);
        const x = buf[0];
        if(x < max) return x % n;
      }
    }

    /* ============== Modal helpers ============== */
    const modal = document.getElementById("drawModal");
    const closeModalBtn = document.getElementById("closeModal");
    const drawTitle = document.getElementById("drawTitle");
    const entrantList = document.getElementById("entrantList");
    const roller = document.getElementById("roller");
    const strip = document.getElementById("strip");
    const winnerLine = document.getElementById("winnerLine");
    closeModalBtn.addEventListener('click', ()=> hideModal());
    function showModal(){ modal.style.display='flex'; modal.setAttribute('aria-hidden','false'); }
    function hideModal(){ modal.style.display='none'; modal.setAttribute('aria-hidden','true'); strip.style.transform='translateY(0)'; }

    function renderEntrantList(entrants){
      entrantList.innerHTML = entrants.length
        ? entrants.map(e => `<div style="padding:8px 12px;border-bottom:1px solid #0f1c2c;display:flex;justify-content:space-between"><span>${escapeHtml(e.name)}</span><span style="color:#a6c9ef">${fmtUsd(e.wagered)}</span></div>`).join("")
        : `<div style="padding:10px 12px;color:#a6c9ef">No qualified entrants yet.</div>`;
    }
    const escapeHtml = s => String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]));

    /* ============== Spinner animation ============== */
    async function spinAndPick(raffleKey, entrants){
      roller.style.display = 'block';
      strip.innerHTML = "";
      winnerLine.textContent = "";

      const names = entrants.map(e=>e.name);
      const repeats = Math.max(30, names.length*3);
      const full = [];
      for(let i=0;i<repeats;i++){
        const name = names[i % names.length];
        full.push(`<div class="name">${escapeHtml(name)}</div>`);
      }
      strip.innerHTML = full.join("");

      const idx = securePick(entrants.length);
      const chosen = entrants[idx].name;

      const stopIndex = full.length - Math.floor(full.length/5) + (idx % Math.floor(full.length/5));
      const rowH = 34;
      const targetY = -(stopIndex * rowH);

      requestAnimationFrame(()=>{
        strip.style.transition = "transform 2.2s cubic-bezier(.2,.7,0,1)";
        strip.style.transform = `translateY(${targetY}px)`;
      });

      await new Promise(r => setTimeout(r, 2300));
      winnerLine.textContent = `ðŸ† Winner: ${chosen}`;
      return chosen;
    }

    /* ============== Logging winners ============== */
    function saveLocalWin(entry){
      const key = "raffle_local_wins";
      const arr = JSON.parse(localStorage.getItem(key) || "[]");
      arr.unshift(entry);
      localStorage.setItem(key, JSON.stringify(arr.slice(0,200)));
    }

    async function logWinServer(entry){
      try{
        const res = await fetch(API_LOG, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(entry)
        });
        if(!res.ok) throw new Error("Server log failed "+res.status);
        return true;
      }catch(err){
        console.warn("Server log failed; saving locally.", err);
        saveLocalWin({ ...entry, source:"local" });
        return false;
      }
    }

    async function loadWinners(){
      const tbody = document.getElementById("wins-body");
      const local = JSON.parse(localStorage.getItem("raffle_local_wins") || "[]");

      let server = [];
      try{
        const res = await fetch(API_WINS, {cache:"no-store"});
        if(res.ok) server = await res.json();
      }catch{}

      const rows = [...server.map(x=>({ ...x, source:"server" })), ...local];

      if(rows.length === 0){
        tbody.innerHTML = `<tr><td colspan="6" style="padding:14px 8px;color:#a6c9ef">No winners recorded yet.</td></tr>`;
        return;
      }

      rows.sort((a,b)=> new Date(b.date) - new Date(a.date));

      tbody.innerHTML = rows.map(r=>{
        const d = new Date(r.date);
        const ds = `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
        return `<tr>
          <td>${ds}</td>
          <td>${escapeHtml(r.raffle||"")}</td>
          <td>${escapeHtml(r.winner||"")}</td>
          <td>${fmtUsd(Number(r.prize||0))}</td>
          <td>${Number(r.entries||0)}</td>
          <td>${r.txid ? escapeHtml(r.txid) : "â€”"}</td>
        </tr>`;
      }).join("");
    }

    /* ============== Draw orchestration ============== */
    async function runDraw(kind){
      const anchorISO = getOrInitAnchor(kind.key);
      const win = windowFromAnchor(anchorISO, kind.days);
      const startISO = isoDate(win.start);
      const endISO   = isoDate(win.end);

      drawTitle.textContent = `${kind.label} Draw â€¢ ${startISO} â†’ ${endISO}`;
      winnerLine.textContent = "";
      roller.style.display = 'none';
      strip.innerHTML = "";
      entrantList.innerHTML = `<div style="padding:10px 12px;color:#a6c9ef">Loading entrantsâ€¦</div>`;
      showModal();

      let entrants = [];
      try{
        entrants = await fetchEntrants(startISO, endISO, kind.min);
      }catch(err){
        entrantList.innerHTML = `<div style="padding:10px 12px;color:#ffaaaa;white-space:pre-wrap">Error loading entrants.\n${String(err).slice(0,200)}</div>`;
        return;
      }

      renderEntrantList(entrants);

      if(entrants.length === 0){
        winnerLine.textContent = "No qualified entrants this window.";
        return;
      }

      const winner = await spinAndPick(kind.key, entrants);

      const entry = {
        date: new Date().toISOString(),
        raffle: kind.label,
        winner,
        prize: kind.prize,
        entries: entrants.length,
        window: { start: startISO, end: endISO }
      };
      await logWinServer(entry);

      const nextStart = new Date(win.end.getTime());
      const nextISO = isoDate(nextStart);
      localStorage.setItem(kind.key, nextISO);

      loadWinners();
    }

    /* ============== Auto draw scheduler ============== */
    function scheduleAuto(kind, ui){
      const tick = async ()=>{
        const anchorISO = getOrInitAnchor(kind.key);
        const win = windowFromAnchor(anchorISO, kind.days);
        if(Date.now() >= win.end.getTime()){
          await runDraw(kind);
          await paintPanel(kind, ui);
        }
      };
      setInterval(tick, 60_000);
      tick();
    }

    /* ============== Panels / UI painting ============== */
    async function paintPanel(kind, ui){
      const anchorISO = getOrInitAnchor(kind.key);
      const win = windowFromAnchor(anchorISO, kind.days);
      const startISO = isoDate(win.start);
      const endISO   = isoDate(win.end);
      ui.window.textContent = humanWindow(win.start, win.end);
      ui.remaining.textContent = remaining(win.end);

      if(ui.__int) clearInterval(ui.__int);
      ui.__int = setInterval(()=> ui.remaining.textContent = remaining(win.end), 60_000);

      try{
        const entrants = await fetchEntrants(startISO, endISO, kind.min);
        ui.participants.textContent = entrants.length;
        ui.viewBtn.onclick = () => {
          drawTitle.textContent = `${kind.label} Entrants â€¢ ${startISO} â†’ ${endISO}`;
          roller.style.display = 'none';
          strip.innerHTML = "";
          winnerLine.textContent = "";
          renderEntrantList(entrants);
          showModal();
        };
      }catch{
        ui.participants.textContent = "â€”";
        ui.viewBtn.onclick = () => {
          drawTitle.textContent = `${kind.label} Entrants â€¢ ${startISO} â†’ ${endISO}`;
          roller.style.display = 'none';
          strip.innerHTML = "";
          winnerLine.textContent = "";
          entrantList.innerHTML = `<div style="padding:10px 12px;color:#ffaaaa">Failed to load entrants.</div>`;
          showModal();
        };
      }

      ui.forceBtn.onclick = () => runDraw(kind);
    }

    /* ============== Boot ============== */
    document.querySelectorAll('.tab-btn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        const tab = btn.dataset.tab;
        document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
        document.getElementById('panel-'+tab).classList.add('active');
        if(tab==='previous') loadWinners();
      });
    });

    const UI = {
      weekly: {
        remaining: document.getElementById('w-remaining'),
        participants: document.getElementById('w-participants'),
        window: document.getElementById('w-window'),
        viewBtn: document.getElementById('w-view'),
        forceBtn: document.getElementById('w-force'),
      },
      monthly: {
        remaining: document.getElementById('m-remaining'),
        participants: document.getElementById('m-participants'),
        window: document.getElementById('m-window'),
        viewBtn: document.getElementById('m-view'),
        forceBtn: document.getElementById('m-force'),
      }
    };

    paintPanel(WEEKLY, UI.weekly);
    paintPanel(MONTHLY, UI.monthly);
    scheduleAuto(WEEKLY, UI.weekly);
    scheduleAuto(MONTHLY, UI.monthly);
    loadWinners();
  </script>
</body>
</html>
