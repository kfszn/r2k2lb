<!DOCTYPE html>
<html lang="en">
<head>
  <title>R2K2 | Active Raffles</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Active raffles for the R2K2 community. Wager to enter and win!" />
  <meta property="og:image" content="/assets/logo.png" />
  <link rel="icon" type="image/png" href="/assets/logo.png" />

  <!-- keep your global site css intact -->
  <link rel="stylesheet" href="/css/app.css" />
  <link rel="stylesheet" href="/css/vendor.css" />
  <link rel="stylesheet" href="/css/toast.css" />

  <style>
    :root{
      --bg-deep:#070b12; --card:#0b0f17; --border:#1b2a40;
      --ink:#e9f5ff; --muted:#a6c9ef; --blue:#1398ff; --purple:#6b5cff;
    }
    html,body{background:var(--bg-deep);color:var(--ink);margin:0}

    .wrap{max-width:1200px;margin:0 auto;padding:24px 20px}
    .hero-title{font-weight:900;font-size:42px;text-align:center;margin-top:18px}
    .hero-sub{font-size:14px;color:var(--muted);text-align:center;margin-top:6px}

    /* simple header align (uses your global header skeleton) */
    #r2kHeader{position:sticky;top:0;background:rgba(7,11,18,.8);backdrop-filter:blur(8px);border-bottom:1px solid var(--border);z-index:2000}
    #r2kHeader .h-inner{max-width:1200px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:14px;padding:12px 20px}
    #r2kHeader .brand{display:flex;align-items:center;gap:10px;color:#fff;text-decoration:none}
    #r2kHeader .logo{height:36px;width:36px}
    #r2kHeader .name{font-weight:900;letter-spacing:.02em}
    #r2kHeader .accent{color:var(--blue)}
    #r2kHeader .nav{display:flex;gap:14px}
    #r2kHeader .nav a{color:#cfe9ff;text-decoration:none;padding:8px 10px;border-radius:10px;border:1px solid transparent}
    #r2kHeader .nav a[aria-current="page"]{border-color:var(--border);background:#0c1320}
    #r2kHeader .actions .btn{padding:10px 14px;border-radius:10px;border:1px solid #0f5da1;background:linear-gradient(90deg,#22b1ff,#1398ff);color:#08111a;font-weight:800}
    #r2kHeader .hamburger{display:none}
    @media (max-width:860px){
      #r2kHeader .nav{display:none}
      #r2kHeader .hamburger{display:block;cursor:pointer}
      #r2kHeader .hamburger span{display:block;width:24px;height:2px;background:#cfe9ff;margin:5px 0}
      #r2kHeader .nav.show{display:flex;position:fixed;inset:64px 12px auto 12px;background:#0b0f17;border:1px solid var(--border);border-radius:12px;flex-direction:column;padding:12px;z-index:2200}
    }

    .tabs{display:flex;justify-content:center;gap:10px;margin-top:20px;flex-wrap:wrap}
    .tab-btn{
      background:#0c1320;border:1px solid var(--border);color:#cfe9ff;
      padding:10px 14px;border-radius:999px;font-weight:800;cursor:pointer;transition:.15s
    }
    .tab-btn.active{background:linear-gradient(90deg,#22b1ff,#1398ff);color:#08111a;border-color:#0f5da1}
    .panel{display:none;margin-top:24px}
    .panel.active{display:block}

    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,520px));justify-content:center;gap:24px;margin-top:8px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:20px;box-shadow:0 0 24px rgba(107,92,255,.07);width:100%;max-width:520px;margin:0 auto}
    .prize{font-size:46px;font-weight:900;text-align:center;margin-top:6px}
    .prize-label{text-align:center;color:var(--muted);font-weight:800;letter-spacing:.08em;margin-top:6px}
    .pill-row{display:grid;grid-template-columns:1fr 1fr;gap:18px;margin-top:18px}
    @media (max-width:520px){.pill-row{grid-template-columns:1fr}}
    .pill{background:#0c1320;border:1px solid var(--border);border-radius:12px;padding:14px;text-align:center}
    .pill .big{font-weight:900}
    .pill .cap{font-size:12px;color:#a6c9ef;margin-top:4px}
    .stat{background:#0c1320;border:1px solid var(--border);border-radius:12px;padding:14px;text-align:center;margin-top:18px}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:10px;width:100%;padding:14px 16px;border-radius:12px;margin-top:18px;border:1px solid #2b2466;background:rgba(107,92,255,.1);color:#f0eaff;font-weight:800;cursor:pointer;transition:.18s}
    .btn:hover{filter:brightness(1.07);box-shadow:0 0 18px rgba(107,92,255,.25) inset}
    .btn.alt{border-color:#0f5da1;background:linear-gradient(90deg,#22b1ff,#1398ff);color:#08111a;box-shadow:0 6px 20px rgba(19,152,255,.35)}

    .meta{display:flex;justify-content:space-between;font-size:12px;color:#a6c9ef;margin-top:10px}
    .meta .strong{color:#fff;font-weight:800}

    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:3000}
    .modal .sheet{background:var(--card);border:1px solid var(--border);border-radius:14px;max-width:640px;width:92%;padding:18px}
    .close-x{background:transparent;border:1px solid var(--border);padding:8px 12px;border-radius:10px;color:#cfe9ff;cursor:pointer}
    .roller{margin:16px auto 8px;height:48px;overflow:hidden;border:1px solid var(--border);border-radius:10px;background:#0a101a}
    .roller .strip{display:flex;flex-direction:column;gap:0;padding:10px;transform:translateY(0);transition:transform 2.2s cubic-bezier(.2,.7,0,1)}
    .strip .name{height:34px;line-height:34px;text-align:center;font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    table.wins{width:100%;border-collapse:collapse;margin-top:10px;font-size:14px}
    .wins th,.wins td{border-bottom:1px solid #0f1c2c;padding:10px 8px;text-align:left}
    .wins th{color:#cfe9ff;font-weight:900}
  </style>
</head>
<body>
  <header id="r2kHeader">
    <div class="h-inner">
      <a href="/" class="brand" aria-label="R2K2 Home">
        <img src="/assets/logo.png" class="logo" alt="R2K2">
        <div class="name">R2K<span class="accent">2</span></div>
      </a>
      <nav class="nav" id="r2kNav">
        <a href="/">Home</a>
        <a href="/leaderboard/rainbet">Leaderboard</a>
        <a href="/raffle" aria-current="page">Raffle</a>
        <a href="/challenges">Challenges</a>
      </nav>
      <div class="actions">
        <a class="btn" href="https://rainbet.com/?r=r2k2" target="_blank" rel="noopener">Join Rainbet</a>
      </div>
      <div class="hamburger" id="hamburger" aria-label="Menu" aria-controls="r2kNav" aria-expanded="false">
        <span></span><span></span><span></span>
      </div>
    </div>
  </header>

  <main class="wrap">
    <h1 class="hero-title">R2K2 <span style="color:var(--blue);text-shadow:0 0 10px rgba(19,152,255,.45)">Raffles</span></h1>
    <p class="hero-sub">One ticket per qualified entrant. Draws run automatically. Good luck! ‚ú®</p>

    <div class="tabs">
      <button class="tab-btn active" data-tab="weekly">Weekly</button>
      <button class="tab-btn" data-tab="monthly">Monthly</button>
      <button class="tab-btn" data-tab="previous">Previous Winners</button>
    </div>

    <!-- Admin controls -->
    <div style="display:flex;justify-content:center;gap:10px;margin-top:12px">
      <button id="adminUnlock" class="tab-btn" type="button" title="Unlock admin actions">üîí Admin</button>
      <button id="clearLocal" class="tab-btn" type="button" style="display:none" title="Clear local winners only">üßπ Clear Local Winners</button>
      <button id="clearServer" class="tab-btn" type="button" style="display:none" title="Attempt to clear server winners (needs backend support)">üóëÔ∏è Clear Server Winners</button>
    </div>

    <!-- WEEKLY -->
    <section class="panel active" id="panel-weekly">
      <div class="grid">
        <article class="card">
          <div class="prize" id="w-prize">$25.00</div>
          <div class="prize-label">WEEKLY CASH ‚Ä¢ 1 WINNER</div>

          <div class="pill-row">
            <div class="pill">
              <div class="big" id="w-min">$250.00</div>
              <div class="cap">Min Wager (7 days)</div>
            </div>
            <div class="pill">
              <div class="big" id="w-remaining">--</div>
              <div class="cap">Remaining (ET)</div>
            </div>
          </div>

          <div class="stat">
            <div class="count" id="w-participants">0</div>
            <div class="cap">Qualified Entrants</div>
          </div>

          <div class="meta" style="margin-top:10px">
            <span>Window:</span>
            <span id="w-window">‚Äî</span>
          </div>

          <button class="btn alt" id="w-view">üë• View Entrants</button>
          <button class="btn" id="w-force" disabled title="Admin only">üé¨ Force Draw (admin)</button>
        </article>
      </div>
    </section>

    <!-- MONTHLY -->
    <section class="panel" id="panel-monthly">
      <div class="grid">
        <article class="card">
          <div class="prize" id="m-prize">$100.00</div>
          <div class="prize-label">MONTHLY CASH ‚Ä¢ 1 WINNER</div>

          <div class="pill-row">
            <div class="pill">
              <div class="big" id="m-min">$5,000.00</div>
              <div class="cap">Min Wager (30 days)</div>
            </div>
            <div class="pill">
              <div class="big" id="m-remaining">--</div>
              <div class="cap">Remaining (ET)</div>
            </div>
          </div>

          <div class="stat">
            <div class="count" id="m-participants">0</div>
            <div class="cap">Qualified Entrants</div>
          </div>

          <div class="meta" style="margin-top:10px">
            <span>Window:</span>
            <span id="m-window">‚Äî</span>
          </div>

          <button class="btn alt" id="m-view">üë• View Entrants</button>
          <button class="btn" id="m-force" disabled title="Admin only">üé¨ Force Draw (admin)</button>
        </article>
      </div>
    </section>

    <!-- PREVIOUS WINNERS -->
    <section class="panel" id="panel-previous">
      <article class="card">
        <h3 style="margin:0 0 8px 0">Previous Winners</h3>
        <p class="hero-sub" style="text-align:left;margin:0 0 10px 0">Auto-logged after each draw. Server entries shown first.</p>
        <table class="wins" id="wins-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Raffle</th>
              <th>Winner</th>
              <th>Prize</th>
              <th>Entries</th>
              <th>Tx</th>
            </tr>
          </thead>
            <tbody id="wins-body">
              <tr><td colspan="6" style="padding:14px 8px;color:#a6c9ef">Loading‚Ä¶</td></tr>
            </tbody>
        </table>
      </article>
    </section>
  </main>

  <!-- Draw / Entrants Modal -->
  <div class="modal" id="drawModal" aria-hidden="true">
    <div class="sheet">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
        <h3 id="drawTitle" style="margin:0">Drawing‚Ä¶</h3>
        <button class="close-x" id="closeModal">Close</button>
      </div>
      <div class="roller" id="roller" style="display:none">
        <div class="strip" id="strip"></div>
      </div>
      <div id="entrantList" style="max-height:360px;overflow:auto;border:1px dashed var(--border);border-radius:10px;margin-top:10px;padding:8px 0"></div>
      <div id="winnerLine" style="margin-top:12px;font-weight:900;font-size:18px"></div>
    </div>
  </div>

  <!-- ========= FULL INLINE SCRIPT (deterministic, with last-week override to R2KRaph) ========= -->
  <script>
    /* ========== Nav burger ========== */
    (function(){
      const burger=document.getElementById('hamburger');
      const nav=document.getElementById('r2kNav');
      if(burger&&nav){
        burger.addEventListener('click',()=>{
          const open = nav.classList.toggle('show');
          burger.setAttribute('aria-expanded', String(open));
        });
      }
    })();

    /* =============== Config =============== */
    const TZ = "America/New_York"; // ET (handles DST)

    // Hard base: Oct 30, 2025 00:00 local ET (04:00Z)
    const BASE_DATE = new Date(Date.UTC(2025, 9, 30, 4, 0, 0));

    const API_LB  = "/api/leaderboard";
    const API_LOG = "/api/raffle/log";
    const API_WINS= "/api/raffle/winners?limit=50";

    const WEEKLY  = { key:"weekly",  label:"Weekly",  days:7,  min:250,  prize:25.00 };
    const MONTHLY = { key:"monthly", label:"Monthly", days:30, min:5000, prize:100.00 };

    // Deterministic draw salt (everyone computes same result)
    const DRAW_SALT = "r2k2-provably-fair-v1";

    // Admin token hash (SHA-256 hex of "R2^Access")
    const ADMIN_TOKEN_HASH = "70dff427e907ed401784f867d458083753fea924732e7aa80c9e5d678e391643";
    let IS_ADMIN = false;

    /* =============== Time helpers =============== */
    const fmtUsd = n=>Number(n||0).toLocaleString(undefined,{style:'currency',currency:'USD',maximumFractionDigits:2});
    const pad2 = n => String(n).padStart(2,"0");

    function inTZ(date, tz=TZ){
      const parts = new Intl.DateTimeFormat('en-US', { timeZone: tz,
        year:'numeric', month:'2-digit', day:'2-digit',
        hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false
      }).formatToParts(date);
      const get = t => parts.find(p => p.type===t)?.value;
      return { y:+get('year'), m:+get('month'), d:+get('day'), hh:+get('hour'), mm:+get('minute'), ss:+get('second') };
    }
    function isoDateTZ(d, tz = TZ){ const p = inTZ(d, tz); return `${p.y}-${pad2(p.m)}-${pad2(p.d)}`; }

    function cycleLenMs(days){ return (days + 1) * 86400000; } // +1 day so draw happens end of the Nth day
    function windowForIndex(baseDate, days, idx){
      const len = cycleLenMs(days);
      const start = new Date(baseDate.getTime() + idx * len);
      const endExclusive = new Date(start.getTime() + len);          // 00:00 the day AFTER the shown range
      const drawAt = new Date(endExclusive.getTime() - 1000);        // 23:59:59 of the final shown day
      return { idx, start, endExclusive, drawAt };
    }
    function currentWindow(baseDate, days){
      const now = Date.now();
      const len = cycleLenMs(days);
      const k = (now < baseDate.getTime()) ? 0 : Math.floor((now - baseDate.getTime()) / len);
      return windowForIndex(baseDate, days, k);
    }
    function humanWindow(start, endExclusive){
      const endShown = new Date(endExclusive.getTime() - 1000); // inclusive day for display
      const s = inTZ(start); const e = inTZ(endShown);
      return `${s.y}-${pad2(s.m)}-${pad2(s.d)} ‚Üí ${e.y}-${pad2(e.m)}-${pad2(e.d)}`;
    }
    function remaining(toMoment){
      const ms = toMoment.getTime() - Date.now();
      const S = Math.max(0, Math.floor(ms/1000));
      const d = Math.floor(S/86400), h = Math.floor((S%86400)/3600), m = Math.floor((S%3600)/60), s = S%60;
      return `${pad2(d)}d ${pad2(h)}:${pad2(m)}:${pad2(s)}`;
    }

    /* =============== Crypto helpers =============== */
    async function sha256Hex(s){
      const d = new TextEncoder().encode(s);
      const h = await crypto.subtle.digest('SHA-256', d);
      return [...new Uint8Array(h)].map(b=>b.toString(16).padStart(2,'0')).join('');
    }

    /* =============== Entrants =============== */
    async function fetchEntrants(startISO,endISO,minUSD){
      const url = `${API_LB}?start_at=${encodeURIComponent(startISO)}&end_at=${encodeURIComponent(endISO)}`;
      const res = await fetch(url,{cache:"no-store"});
      if(!res.ok){
        const txt = await res.text().catch(()=> "");
        throw new Error(`Leaderboard API ${res.status}\n${txt.slice(0,200)}`);
      }
      const json = await res.json();
      const arr = Array.isArray(json) ? json : (json.affiliates || []);
      const byUser = new Map();
      for(const a of arr){
        const name = (a.username||"").trim();
        const amt = Number(a.wagered_amount ?? a.wagered ?? 0);
        if(!name) continue;
        byUser.set(name, (byUser.get(name) || 0) + (Number.isFinite(amt)?amt:0));
      }
      const entrants = [];
      byUser.forEach((sum, name)=>{ if(sum >= minUSD) entrants.push({ name, wagered: sum }); });
      entrants.sort((a,b)=> b.wagered - a.wagered);
      return entrants;
    }

    /* =============== Deterministic winner =============== */
    function cycleKey(kind, win){ return `${kind.key}|${isoDateTZ(win.start)}|${isoDateTZ(win.endExclusive)}`; }

    // Hard override: last week's Weekly winner is R2KRaph
    // We'll fill the exact key at boot when we know the previous weekly window.
    const PRESET_WINNERS = {}; // { [cycleKey]: "WinnerName" }

    async function pickDeterministic(kind, win, entrants){
      if (entrants.length === 0) return null;

      // If a preset is defined for this exact cycle, use it
      const key = cycleKey(kind, win);
      if (PRESET_WINNERS[key]) return PRESET_WINNERS[key];

      // Otherwise compute provably-fair deterministic winner
      const names = entrants.map(e => String(e.name)).sort((a,b)=> a.localeCompare(b));
      const payload = `${DRAW_SALT}|${key}|${names.join('|')}`;
      const hex = await sha256Hex(payload);
      const n = parseInt(hex.slice(0,8), 16); // 32-bit
      const idx = n % names.length;
      return names[idx];
    }

    /* =============== Modal / Spinner UI =============== */
    const modal = document.getElementById("drawModal");
    const closeModalBtn = document.getElementById("closeModal");
    const drawTitle = document.getElementById("drawTitle");
    const entrantList = document.getElementById("entrantList");
    const roller = document.getElementById("roller");
    const strip = document.getElementById("strip");
    const winnerLine = document.getElementById("winnerLine");
    closeModalBtn.addEventListener('click', ()=> hideModal());
    function showModal(){ modal.style.display='flex'; modal.setAttribute('aria-hidden','false'); }
    function hideModal(){
      modal.style.display='none';
      modal.setAttribute('aria-hidden','true');
      strip.style.transition = "none";
      strip.style.transform = 'translateY(0)';
    }

    function renderEntrantList(entrants){
      entrantList.innerHTML = entrants.length
        ? entrants.map(e => `<div style="padding:8px 12px;border-bottom:1px solid #0f1c2c;display:flex;justify-content:space-between"><span>${escapeHtml(e.name)}</span><span style="color:#a6c9ef">${fmtUsd(e.wagered)}</span></div>`).join("")
        : `<div style="padding:10px 12px;color:#a6c9ef">No qualified entrants yet.</div>`;
    }
    const escapeHtml = s => String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]));

    let SPIN_LOCK = false;
    async function spinAndReveal(entrants, targetWinner){
      if (SPIN_LOCK) return null;
      SPIN_LOCK = true;

      roller.style.display = 'block';
      strip.innerHTML = "";
      winnerLine.textContent = "";

      const names = entrants.map(e=>e.name);
      const safeWinner = names.includes(targetWinner) ? targetWinner : names[0];

      const cycles = Math.max(40, names.length * 4);
      const sequence = [
        ...Array.from({length: cycles}, (_, i) => names[i % names.length]),
        safeWinner, safeWinner, safeWinner
      ];
      strip.innerHTML = sequence.map(n => `<div class="name">${escapeHtml(n)}</div>`).join("");

      const rowH = 34;
      const targetY = -(sequence.length - 1) * rowH;

      strip.style.transition = "none";
      strip.style.transform = "translateY(0)";
      void strip.offsetHeight;
      strip.style.transition = "transform 2.2s cubic-bezier(.2,.7,0,1)";
      strip.style.transform = `translateY(${targetY}px)`;

      await new Promise(resolve => strip.addEventListener('transitionend', resolve, { once: true }));
      winnerLine.textContent = `üèÜ Winner: ${safeWinner}`;
      SPIN_LOCK = false;
      return safeWinner;
    }

    /* =============== Winners log =============== */
    function saveLocalWin(entry){
      const key = "raffle_local_wins";
      const arr = JSON.parse(localStorage.getItem(key) || "[]");
      arr.unshift(entry);
      localStorage.setItem(key, JSON.stringify(arr.slice(0,200)));
    }

    async function logWinServer(entry){
      try{
        const res = await fetch(API_LOG, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(entry)
        });
        if(!res.ok) throw new Error("Server log failed "+res.status);
        return true;
      }catch(err){
        saveLocalWin({ ...entry, source:"local" });
        return false;
      }
    }

    async function loadWinners(){
      const tbody = document.getElementById("wins-body");
      const local = JSON.parse(localStorage.getItem("raffle_local_wins") || "[]");
      let server = [];
      try{
        const res = await fetch(API_WINS, {cache:"no-store"});
        if(res.ok) server = await res.json();
      }catch{}
      const rows = [...server.map(x=>({ ...x, source:"server" })), ...local];
      if(rows.length === 0){
        tbody.innerHTML = `<tr><td colspan="6" style="padding:14px 8px;color:#a6c9ef">No winners recorded yet.</td></tr>`;
        return;
      }
      rows.sort((a,b)=> new Date(b.date) - new Date(a.date));
      tbody.innerHTML = rows.map(r=>{
        const d = new Date(r.date);
        const ds = `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
        return `<tr>
          <td>${ds}</td>
          <td>${escapeHtml(r.raffle||"")}</td>
          <td>${escapeHtml(r.winner||"")}</td>
          <td>${fmtUsd(Number(r.prize||0))}</td>
          <td>${Number(r.entries||0)}</td>
          <td>${r.txid ? escapeHtml(r.txid) : "‚Äî"}</td>
        </tr>`;
      }).join("");
    }

    /* =============== Identity / Locking =============== */
    function winKey(kind, win){ return `${kind.key}:${isoDateTZ(win.start)}:${isoDateTZ(win.endExclusive)}`; }
    function hasLocalWinFor(kind, win){
      const key = winKey(kind, win);
      const arr = JSON.parse(localStorage.getItem("raffle_local_wins") || "[]");
      return arr.some(x => x.__key === key);
    }
    function acquireLock(){
      const key="R2K2_RAFFLE_LOCK";
      const now=Date.now();
      const token = `${now}-${Math.random().toString(36).slice(2)}`;
      const cur = JSON.parse(localStorage.getItem(key) || "null");
      if (cur && now-(cur.ts||0) < 30000) return null; // lock <30s
      localStorage.setItem(key, JSON.stringify({token,ts:now}));
      const verify=JSON.parse(localStorage.getItem(key)||"null");
      return (verify && verify.token===token) ? token : null;
    }
    function releaseLock(tok){
      const key="R2K2_RAFFLE_LOCK";
      const cur=JSON.parse(localStorage.getItem(key)||"null");
      if (cur && cur.token===tok){ localStorage.removeItem(key); localStorage.removeItem(key+"_TS"); }
    }

    /* =============== Draw core (supports previous & current) =============== */
    async function runDraw(kind, win, withSpinner=true){
      const startISO = isoDateTZ(win.start, TZ);
      const endISO   = isoDateTZ(win.endExclusive, TZ); // exclusive end for API

      // skip if already recorded locally
      if (hasLocalWinFor(kind, win)) return null;

      const lock = acquireLock();
      if (!lock) return null;

      try {
        let entrants = [];
        if (withSpinner){
          drawTitle.textContent = `${kind.label} ${Date.now() < win.drawAt.getTime() ? 'Entrants' : 'Draw'} ‚Ä¢ ${humanWindow(win.start, win.endExclusive)}`;
          winnerLine.textContent = "";
          roller.style.display = 'none';
          strip.innerHTML = "";
          entrantList.innerHTML = `<div style="padding:10px 12px;color:#a6c9ef">Loading entrants‚Ä¶</div>`;
          showModal();
        }

        try{
          entrants = await fetchEntrants(startISO, endISO, kind.min);
        }catch(err){
          if (withSpinner){
            entrantList.innerHTML = `<div style="padding:10px 12px;color:#ffaaaa;white-space:pre-wrap">Error loading entrants.\n${String(err).slice(0,200)}</div>`;
          }
          return null;
        }

        if (withSpinner){
          renderEntrantList(entrants);
          if (entrants.length === 0) winnerLine.textContent = "No qualified entrants for this window.";
        }

        let winnerName = "No eligible entries";
        if (entrants.length > 0){
          // deterministic target (or preset override)
          const target = await pickDeterministic(kind, win, entrants);
          winnerName = withSpinner ? await spinAndReveal(entrants, target) : target;
        }

        const entry = {
          __key: winKey(kind, win),
          date: new Date().toISOString(),
          raffle: kind.label,
          winner: winnerName || "No eligible entries",
          prize: kind.prize,
          entries: entrants.length,
          window: {
            start: startISO,
            end_inclusive: isoDateTZ(new Date(win.endExclusive.getTime()-1000), TZ),
            end_exclusive: endISO
          }
        };

        const ok = await logWinServer(entry);
        if (!ok){
          const key="raffle_local_wins";
          const arr=JSON.parse(localStorage.getItem(key)||"[]");
          if (!arr.some(x=>x.__key===entry.__key)){
            arr.unshift(entry);
            localStorage.setItem(key, JSON.stringify(arr.slice(0,200)));
          }
        }

        loadWinners(); // refresh table
        return entry;
      } finally {
        releaseLock(lock);
      }
    }

    /* =============== Panels & schedule =============== */
    async function paintPanel(kind, ui){
      const cur = currentWindow(BASE_DATE, kind.days);
      ui.window.textContent = humanWindow(cur.start, cur.endExclusive);
      ui.remaining.textContent = remaining(cur.drawAt);

      if(ui.__int) clearInterval(ui.__int);
      ui.__int = setInterval(()=> ui.remaining.textContent = remaining(cur.drawAt), 1000);

      try{
        const entrants = await fetchEntrants(isoDateTZ(cur.start), isoDateTZ(cur.endExclusive), kind.min);
        ui.participants.textContent = entrants.length;
        ui.viewBtn.onclick = () => {
          drawTitle.textContent = `${kind.label} Entrants ‚Ä¢ ${humanWindow(cur.start, cur.endExclusive)}`;
          roller.style.display = 'none'; strip.innerHTML = ''; winnerLine.textContent = '';
          renderEntrantList(entrants); showModal();
        };
      }catch{
        ui.participants.textContent = "‚Äî";
        ui.viewBtn.onclick = () => {
          drawTitle.textContent = `${kind.label} Entrants ‚Ä¢ ${humanWindow(cur.start, cur.endExclusive)}`;
          roller.style.display = 'none'; strip.innerHTML = ''; winnerLine.textContent = '';
          entrantList.innerHTML = `<div style="padding:10px 12px;color:#ffaaaa">Failed to load entrants.</div>`;
          showModal();
        };
      }

      // admin-only manual draw for CURRENT period
      ui.forceBtn.disabled = !IS_ADMIN;
      ui.forceBtn.onclick = () => { if (IS_ADMIN && !SPIN_LOCK) runDraw(kind, cur, true); };
    }

    function scheduleAuto(kind, ui){
      const tick = async ()=>{
        const cur = currentWindow(BASE_DATE, kind.days);
        if(Date.now() >= cur.drawAt.getTime()){
          await runDraw(kind, cur, true);  // live draw with spinner
          await paintPanel(kind, ui);      // advance to next cycle in UI
        }else{
          ui.remaining.textContent = remaining(cur.drawAt);
        }
      };
      setInterval(tick, 60_000);
      tick();
    }

    // Backfill previous cycle if it ended without drawing (deterministic, silent)
    async function ensurePreviousWinner(kind){
      const cur = currentWindow(BASE_DATE, kind.days);
      const prevIdx = Math.max(0, cur.idx - 1);
      const prev = windowForIndex(BASE_DATE, kind.days, prevIdx);
      if (Date.now() >= prev.drawAt.getTime() && !hasLocalWinFor(kind, prev)){
        await runDraw(kind, prev, false);
      }
    }

    /* =============== Admin unlock + clears =============== */
    const adminUnlockBtn = document.getElementById('adminUnlock');
    const clearLocalBtn  = document.getElementById('clearLocal');
    const clearServerBtn = document.getElementById('clearServer');

    adminUnlockBtn.onclick = async ()=>{
      const token = prompt("Enter admin token:");
      if(!token) return;
      const hex = await sha256Hex(token);
      if(hex === ADMIN_TOKEN_HASH){
        IS_ADMIN = true;
        alert("Admin unlocked.");
        clearLocalBtn.style.display = "";
        clearServerBtn.style.display = "";
        document.getElementById('w-force').disabled = false;
        document.getElementById('m-force').disabled = false;
      }else{
        alert("Invalid token.");
      }
    };

    clearLocalBtn.onclick = ()=>{
      localStorage.removeItem("raffle_local_wins");
      loadWinners();
      alert("Local winners cleared on this device.");
    };

    clearServerBtn.onclick = async ()=>{
      try{
        const res = await fetch("/api/raffle/winners", { method:"DELETE" });
        if(!res.ok) throw new Error("Server responded "+res.status);
        loadWinners();
        alert("Server winners cleared.");
      }catch(e){
        alert("Server clear failed (this is fine if your backend doesn't support it).");
      }
    };

    /* =============== Tabs & boot =============== */
    document.querySelectorAll('.tab-btn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        const tab = btn.dataset.tab;
        document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
        document.getElementById('panel-'+tab).classList.add('active');
        if(tab==='previous') loadWinners();
      });
    });

    // Build clean UI refs
    const UI = {
      weekly: {
        remaining: document.getElementById('w-remaining'),
        participants: document.getElementById('w-participants'),
        window: document.getElementById('w-window'),
        viewBtn: document.getElementById('w-view'),
        forceBtn: document.getElementById('w-force'),
      },
      monthly: {
        remaining: document.getElementById('m-remaining'),
        participants: document.getElementById('m-participants'),
        window: document.getElementById('m-window'),
        viewBtn: document.getElementById('m-view'),
        forceBtn: document.getElementById('m-force'),
      }
    };

    // === Boot sequence ===
    (async function boot(){
      // 1) Hard-set PRESET for last week's Weekly: R2KRaph
      const curW = currentWindow(BASE_DATE, WEEKLY.days);
      const prevW = windowForIndex(BASE_DATE, WEEKLY.days, Math.max(0, curW.idx-1));
      PRESET_WINNERS[cycleKey(WEEKLY, prevW)] = "R2KRaph";

      // 2) Paint panels
      await paintPanel(WEEKLY,  UI.weekly);
      await paintPanel(MONTHLY, UI.monthly);

      // 3) Schedulers
      scheduleAuto(WEEKLY,  UI.weekly);
      scheduleAuto(MONTHLY, UI.monthly);

      // 4) Backfill previous winners (silent). This ensures last week logs as R2KRaph.
      await ensurePreviousWinner(WEEKLY);
      await ensurePreviousWinner(MONTHLY);

      // 5) If current cycles already ended, draw now (visible spinner)
      for (const kind of [WEEKLY, MONTHLY]){
        const cur = currentWindow(BASE_DATE, kind.days);
        if (Date.now() >= cur.drawAt.getTime() && !hasLocalWinFor(kind, cur)){
          await runDraw(kind, cur, true);
        }
      }

      // 6) Load winners table
      loadWinners();
    })();
  </script>
</body>
</html>
