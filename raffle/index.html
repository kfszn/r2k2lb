<!DOCTYPE html>
<html lang="en">
<head>
  <title>R2K2 | Active Raffles</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Active raffles for the R2K2 community. Wager to enter and win!" />
  <meta property="og:image" content="/assets/logo.png" />
  <link rel="icon" type="image/png" href="/assets/logo.png" />

  <link rel="stylesheet" href="/css/app.css" />
  <link rel="stylesheet" href="/css/vendor.css" />
  <link rel="stylesheet" href="/css/toast.css" />

  <style>
    :root{
      --bg-deep:#070b12; --card:#0b0f17; --border:#1b2a40;
      --ink:#e9f5ff; --muted:#a6c9ef; --blue:#1398ff; --purple:#6b5cff;
    }
    html,body{background:var(--bg-deep);color:var(--ink);margin:0}

    .wrap{max-width:1200px;margin:0 auto;padding:24px 20px}
    .hero-title{font-weight:900;font-size:42px;text-align:center;margin-top:18px}
    .hero-sub{font-size:14px;color:var(--muted);text-align:center;margin-top:6px}

    .tabs{display:flex;justify-content:center;gap:10px;margin-top:20px;flex-wrap:wrap}
    .tab-btn{
      background:#0c1320;border:1px solid var(--border);color:#cfe9ff;
      padding:10px 14px;border-radius:999px;font-weight:800;cursor:pointer;transition:.15s
    }
    .tab-btn.active{background:linear-gradient(90deg,#22b1ff,#1398ff);color:#08111a;border-color:#0f5da1}
    .panel{display:none;margin-top:24px}
    .panel.active{display:block}

    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,520px));justify-content:center;gap:24px;margin-top:8px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:20px;box-shadow:0 0 24px rgba(107,92,255,.07);width:100%;max-width:520px;margin:0 auto}
    .prize{font-size:46px;font-weight:900;text-align:center;margin-top:6px}
    .prize-label{text-align:center;color:var(--muted);font-weight:800;letter-spacing:.08em;margin-top:6px}
    .pill-row{display:grid;grid-template-columns:1fr 1fr;gap:18px;margin-top:18px}
    @media (max-width:520px){.pill-row{grid-template-columns:1fr}}
    .pill{background:#0c1320;border:1px solid var(--border);border-radius:12px;padding:14px;text-align:center}
    .pill .big{font-weight:900}
    .pill .cap{font-size:12px;color:#a6c9ef;margin-top:4px}
    .stat{background:#0c1320;border:1px solid var(--border);border-radius:12px;padding:14px;text-align:center;margin-top:18px}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:10px;width:100%;padding:14px 16px;border-radius:12px;margin-top:18px;border:1px solid #2b2466;background:rgba(107,92,255,.1);color:#f0eaff;font-weight:800;cursor:pointer;transition:.18s}
    .btn.alt{border-color:#0f5da1;background:linear-gradient(90deg,#22b1ff,#1398ff);color:#08111a;box-shadow:0 6px 20px rgba(19,152,255,.35)}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:3000}
    .modal .sheet{background:var(--card);border:1px solid var(--border);border-radius:14px;max-width:640px;width:92%;padding:18px}
    .close-x{background:transparent;border:1px solid var(--border);padding:8px 12px;border-radius:10px;color:#cfe9ff;cursor:pointer}
    .roller{margin:16px auto 8px;height:48px;overflow:hidden;border:1px solid var(--border);border-radius:10px;background:#0a101a}
    .roller .strip{display:flex;flex-direction:column;gap:0;padding:10px;transform:translateY(0);transition:transform 2.2s cubic-bezier(.2,.7,0,1)}
    .strip .name{height:34px;line-height:34px;text-align:center;font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    table.wins{width:100%;border-collapse:collapse;margin-top:10px;font-size:14px}
    .wins th,.wins td{border-bottom:1px solid #0f1c2c;padding:10px 8px;text-align:left}
    .wins th{color:#cfe9ff;font-weight:900}
  </style>
</head>

<body>
<header id="r2kHeader">
  <div class="h-inner">
    <a href="/" class="brand"><img src="/assets/logo.png" class="logo" alt="R2K2"><div class="name">R2K<span class="accent">2</span></div></a>
    <nav class="nav" id="r2kNav"><a href="/">Home</a><a href="/leaderboard/rainbet">Leaderboard</a><a href="/raffle" aria-current="page">Raffle</a><a href="/challenges">Challenges</a></nav>
    <div class="actions"><a class="btn" href="https://rainbet.com/?r=r2k2" target="_blank">Join Rainbet</a></div>
    <div class="hamburger" id="hamburger"><span></span><span></span><span></span></div>
  </div>
</header>

<main class="wrap">
  <h1 class="hero-title">R2K2 <span style="color:var(--blue)">Raffles</span></h1>
  <p class="hero-sub">One ticket per qualified entrant. Draws run automatically.</p>

  <div class="tabs">
    <button class="tab-btn active" data-tab="weekly">Weekly</button>
    <button class="tab-btn" data-tab="monthly">Monthly</button>
    <button class="tab-btn" data-tab="previous">Previous Winners</button>
  </div>

  <section class="panel active" id="panel-weekly">
    <div class="grid"><article class="card">
      <div class="prize">$25.00</div><div class="prize-label">WEEKLY â€¢ 1 WINNER</div>
      <div class="pill-row"><div class="pill"><div class="big">$250.00</div><div class="cap">Min Wager</div></div><div class="pill"><div class="big" id="w-remaining">--</div><div class="cap">Remaining</div></div></div>
      <div class="stat"><div class="count" id="w-participants">0</div><div class="cap">Qualified Entrants</div></div>
      <div class="meta"><span>Window:</span><span id="w-window"></span></div>
      <button class="btn alt" id="w-view">ðŸ‘¥ View Entrants</button>
    </article></div>
  </section>

  <section class="panel" id="panel-monthly">
    <div class="grid"><article class="card">
      <div class="prize">$100.00</div><div class="prize-label">MONTHLY â€¢ 1 WINNER</div>
      <div class="pill-row"><div class="pill"><div class="big">$5,000.00</div><div class="cap">Min Wager</div></div><div class="pill"><div class="big" id="m-remaining">--</div><div class="cap">Remaining</div></div></div>
      <div class="stat"><div class="count" id="m-participants">0</div><div class="cap">Qualified Entrants</div></div>
      <div class="meta"><span>Window:</span><span id="m-window"></span></div>
      <button class="btn alt" id="m-view">ðŸ‘¥ View Entrants</button>
    </article></div>
  </section>

  <section class="panel" id="panel-previous">
    <article class="card">
      <h3>Previous Winners</h3>
      <table class="wins"><thead><tr><th>Date</th><th>Raffle</th><th>Winner</th><th>Prize</th><th>Entries</th></tr></thead><tbody id="wins-body"><tr><td colspan="5">Loadingâ€¦</td></tr></tbody></table>
    </article>
  </section>
</main>

<div class="modal" id="drawModal">
  <div class="sheet">
    <div style="display:flex;justify-content:space-between"><h3 id="drawTitle">Drawingâ€¦</h3><button class="close-x" id="closeModal">Close</button></div>
    <div class="roller" id="roller" style="display:none"><div class="strip" id="strip"></div></div>
    <div id="entrantList" style="max-height:360px;overflow:auto;border:1px dashed var(--border);border-radius:10px;margin-top:10px;padding:8px 0"></div>
    <div id="winnerLine" style="margin-top:12px;font-weight:900;font-size:18px"></div>
  </div>
</div>

<script>
const TZ = "America/New_York";
const BASE_DATE = new Date(Date.UTC(2025, 9, 30, 4, 0, 0));
const WEEKLY  = { label:"Weekly",  days:7,  min:250,  prize:25 };
const MONTHLY = { label:"Monthly", days:30, min:5000, prize:100 };
const API_LB="/api/leaderboard"; const API_WINS="/api/raffle/winners?limit=100"; const API_LOG="/api/raffle/log";

const modal=document.getElementById("drawModal"),strip=document.getElementById("strip"),roller=document.getElementById("roller"),winnerLine=document.getElementById("winnerLine"),entrantList=document.getElementById("entrantList");
document.getElementById("closeModal").onclick=()=>{modal.style.display="none";strip.style.transition="none";strip.style.transform="translateY(0)"};
function showModal(){modal.style.display="flex";}

function pad(n){return String(n).padStart(2,"0")}
function inTZ(d){return new Date(d.toLocaleString("en-US",{timeZone:TZ}))}
function windowInfo(days){
  const now=new Date(),base=BASE_DATE,ms=86400000,len=(days+1)*ms,k=Math.floor((now-base)/len),start=new Date(base.getTime()+k*len),endEx=new Date(start.getTime()+len),endIn=new Date(endEx.getTime()-1000),drawAt=endIn;
  return {start,endEx,endIn,drawAt,startISO:fmt(start),endExISO:fmt(endEx),endInISO:fmt(endIn)};
}
function fmt(d){const t=inTZ(d);return `${t.getFullYear()}-${pad(t.getMonth()+1)}-${pad(t.getDate())}`}

async function fetchServerWinners(){
  try{const r=await fetch(API_WINS);if(!r.ok)return[];const j=await r.json();return Array.isArray(j)?j:(j.winners||[]);}catch{return[];}
}

async function ensureR2KRAPHInserted(){
  const period={start:"2025-10-30",end_inclusive:"2025-11-05"};
  const all=await fetchServerWinners();
  if(all.some(w=>w.raffle==="Weekly"&&w.window&&w.window.start===period.start))return;
  await fetch(API_LOG,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({date:new Date().toISOString(),raffle:"Weekly",winner:"R2KRAPH",prize:25,entries:1,window:{start:period.start,end_inclusive:period.end_inclusive,end_exclusive:"2025-11-06"}})});
}

async function fetchEntrants(startISO,endExclusiveISO,min){
  const r=await fetch(`${API_LB}?start_at=${startISO}&end_at=${endExclusiveISO}`);
  const j=await r.json(),arr=j.affiliates||j||[];
  const map=new Map(); for(const a of arr){const n=a.username?.trim();const w=+a.wagered_amount||0;if(w>=min)map.set(n,w);}
  return [...map].map(([name,wagered])=>({name,wagered})).sort((a,b)=>b.wagered-a.wagered);
}

function renderEntrants(es){entrantList.innerHTML=es.length?es.map(e=>`<div style="padding:6px 12px;display:flex;justify-content:space-between;border-bottom:1px solid #0f1c2c"><span>${e.name}</span><span>${e.wagered.toFixed(2)}</span></div>`).join(""):`<div style="padding:10px;color:#a6c9ef">No entrants</div>`;}

async function revealWinner(name){
  roller.style.display="block";
  const names=[...Array(50)].map(()=>name);
  strip.innerHTML=names.map(n=>`<div class="name">${n}</div>`).join("");
  strip.style.transition="transform 1.5s ease-out";
  strip.style.transform=`translateY(-${(names.length-1)*34}px)`;
  await new Promise(res=>strip.addEventListener("transitionend",res,{once:true}));
  winnerLine.textContent=`ðŸ† Winner: ${name}`;
}

async function draw(kind){
  const win=windowInfo(kind.days),start=win.startISO,endIn=win.endInISO,endEx=win.endExISO;
  const existing=(await fetchServerWinners()).find(w=>w.raffle===kind.label&&w.window&&w.window.start===start&&w.window.end_inclusive===endIn);
  showModal();
  if(existing){winnerLine.textContent="Revealing winner...";await revealWinner(existing.winner);return;}
  const entrants=await fetchEntrants(start,endEx,kind.min);renderEntrants(entrants);
  if(entrants.length===0){winnerLine.textContent="No qualified entrants.";return;}
  const idx=Math.floor(Math.random()*entrants.length),winner=entrants[idx].name;
  await revealWinner(winner);
  await fetch(API_LOG,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({date:new Date().toISOString(),raffle:kind.label,winner,prize:kind.prize,entries:entrants.length,window:{start,end_inclusive:endIn,end_exclusive:endEx}})});
}

async function loadPanel(kind,pfx){
  const ui={remaining:document.getElementById(`${pfx}-remaining`),participants:document.getElementById(`${pfx}-participants`),window:document.getElementById(`${pfx}-window`),view:document.getElementById(`${pfx}-view`)};
  const win=windowInfo(kind.days);ui.window.textContent=`${win.startISO} â†’ ${win.endInISO}`;
  const entrants=await fetchEntrants(win.startISO,win.endExISO,kind.min);ui.participants.textContent=entrants.length;
  ui.view.onclick=()=>{showModal();renderEntrants(entrants);winnerLine.textContent="";roller.style.display="none";strip.innerHTML="";};
  setInterval(()=>ui.remaining.textContent="Next Draw @ "+win.endInISO,1000);
}

[
  ["weekly",WEEKLY],
  ["monthly",MONTHLY]
].forEach(([p,kind])=>loadPanel(kind,p[0]));

document.querySelectorAll('.tab-btn').forEach(b=>b.onclick=()=>{document.querySelectorAll('.tab-btn').forEach(x=>x.classList.remove('active'));b.classList.add('active');document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));document.getElementById("panel-"+b.dataset.tab).classList.add('active');if(b.dataset.tab==="previous")loadWinners();});

async function loadWinners(){
  const body=document.getElementById("wins-body");
  const rows=await fetchServerWinners();
  if(rows.length===0){body.innerHTML=`<tr><td colspan="5">No winners yet.</td></tr>`;return;}
  body.innerHTML=rows.sort((a,b)=>new Date(b.date)-new Date(a.date)).map(r=>`<tr><td>${r.date.split("T")[0]}</td><td>${r.raffle}</td><td>${r.winner}</td><td>$${r.prize}</td><td>${r.entries}</td></tr>`).join("");
}

await ensureR2KRAPHInserted();
loadWinners();

setInterval(async()=>{const now=new Date();if(now >= windowInfo(WEEKLY.days).drawAt)draw(WEEKLY);if(now >= windowInfo(MONTHLY.days).drawAt)draw(MONTHLY);},60000);
</script>
</body>
</html>
