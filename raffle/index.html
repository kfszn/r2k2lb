<!DOCTYPE html>
<html lang="en">
<head>
  <title>R2K2 | Raffles</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="R2K2 Weekly & Monthly Raffles" />
  <meta property="og:image" content="/assets/logo.png" />
  <link rel="icon" type="image/png" href="/assets/logo.png" />

  <!-- your global CSS -->
  <link rel="stylesheet" href="/css/app.css" />
  <link rel="stylesheet" href="/css/vendor.css" />
  <link rel="stylesheet" href="/css/toast.css" />

  <style>
    :root{
      --bg:#070b12;
      --card:#0b0f17;
      --border:#1b2a40;
      --ink:#e9f5ff;
      --muted:#a6c9ef;
      --blue:#1398ff;
    }
    html,body{
      margin:0;
      background:var(--bg);
      color:var(--ink);
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    }
    .wrap{
      max-width:1200px;
      margin:0 auto;
      padding:24px 20px 48px;
    }
    .hero-title{
      font-size:42px;
      font-weight:900;
      text-align:center;
      margin-top:24px;
    }
    .hero-sub{
      text-align:center;
      color:var(--muted);
      margin-top:6px;
      font-size:14px;
    }

    /* Tabs */
    .tabs{
      display:flex;
      justify-content:center;
      gap:10px;
      margin-top:20px;
      flex-wrap:wrap;
    }
    .tab-btn{
      background:#0c1320;
      border:1px solid var(--border);
      color:#cfe9ff;
      padding:8px 14px;
      border-radius:999px;
      font-weight:800;
      font-size:13px;
      cursor:pointer;
      transition:background .15s,border-color .15s,transform .1s;
    }
    .tab-btn.active{
      background:linear-gradient(90deg,#22b1ff,#1398ff);
      border-color:#0f5da1;
      color:#08111a;
      transform:translateY(-1px);
    }
    .tab-btn.admin-pill{
      font-weight:700;
      font-size:12px;
    }
    .admin-only{
      display:none;
    }

    /* Panels + cards */
    .panel{display:none;margin-top:24px;}
    .panel.active{display:block;}

    .grid{
      display:flex;
      justify-content:center;
    }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:18px;
      padding:20px;
      width:100%;
      max-width:520px;
      box-shadow:0 0 24px rgba(19,152,255,0.08);
    }
    .prize{
      font-size:46px;
      font-weight:900;
      text-align:center;
      margin-top:6px;
    }
    .prize-label{
      text-align:center;
      color:var(--muted);
      margin-top:4px;
      letter-spacing:.08em;
      font-weight:800;
      font-size:11px;
      text-transform:uppercase;
    }

    .pill-row{
      display:flex;
      gap:16px;
      margin-top:18px;
      flex-wrap:wrap;
    }
    .pill{
      flex:1;
      min-width:130px;
      background:#0c1320;
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
      text-align:center;
    }
    .pill .big{
      font-weight:900;
      font-size:16px;
    }
    .pill .cap{
      font-size:11px;
      color:var(--muted);
      margin-top:4px;
      text-transform:uppercase;
      letter-spacing:.06em;
    }

    .stat{
      margin-top:16px;
      background:#0c1320;
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
      text-align:center;
    }
    .stat .count{
      font-size:22px;
      font-weight:900;
    }
    .stat .cap{
      font-size:11px;
      color:var(--muted);
      margin-top:3px;
      text-transform:uppercase;
      letter-spacing:.06em;
    }

    .meta-line{
      margin-top:10px;
      font-size:12px;
      color:var(--muted);
      display:flex;
      justify-content:space-between;
      gap:8px;
    }
    .meta-line strong{
      color:var(--ink);
    }

    .btn{
      width:100%;
      margin-top:16px;
      padding:12px 16px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#101827;
      color:#cfe9ff;
      font-weight:700;
      font-size:14px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      transition:background .15s,box-shadow .15s,transform .08s;
    }
    .btn:hover{
      background:#151f32;
      box-shadow:0 0 14px rgba(19,152,255,0.35);
      transform:translateY(-1px);
    }
    .btn.alt{
      background:linear-gradient(90deg,#22b1ff,#1398ff);
      border-color:#0f5da1;
      color:#08111a;
    }

    /* Previous winners table */
    table.wins{
      width:100%;
      border-collapse:collapse;
      margin-top:10px;
      font-size:13px;
    }
    .wins th,.wins td{
      border-bottom:1px solid #111d30;
      padding:8px 6px;
      text-align:left;
    }
    .wins th{
      color:#cfe9ff;
      font-weight:800;
      text-transform:uppercase;
      font-size:11px;
      letter-spacing:.08em;
    }

    /* Modal */
    .modal{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.6);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:3000;
    }
    .modal.show{display:flex;}
    .sheet{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      padding:18px 18px 20px;
      width:95%;
      max-width:520px;
      box-shadow:0 0 32px rgba(0,0,0,.7);
    }

    .sheet-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      margin-bottom:8px;
    }
    .sheet-title{
      margin:0;
      font-size:18px;
      font-weight:800;
    }
    .close-x{
      border:1px solid var(--border);
      background:#0c1320;
      color:#cfe9ff;
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      cursor:pointer;
    }

    .roller{
      margin:10px 0 8px;
      height:48px;
      overflow:hidden;
      border-radius:12px;
      border:1px solid var(--border);
      background:#060a11;
    }
    .strip{
      display:flex;
      flex-direction:column;
      transform:translateY(0);
      transition:transform 2.2s cubic-bezier(.2,.7,0,1);
    }
    .name{
      height:34px;
      line-height:34px;
      text-align:center;
      font-weight:800;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    #entrantList{
      max-height:260px;
      overflow:auto;
      border-radius:12px;
      border:1px dashed var(--border);
      margin-top:8px;
    }
    #entrantList .row{
      padding:6px 10px;
      border-bottom:1px solid #0f1a2a;
      display:flex;
      justify-content:space-between;
      gap:8px;
      font-size:13px;
    }
    #winnerLine{
      margin-top:10px;
      font-size:18px;
      font-weight:900;
    }

    @media (max-width:600px){
      .hero-title{font-size:32px;}
      .pill-row{flex-direction:column;}
    }
  </style>
</head>
<body>
  <!-- Simple header using your global styles -->
  <header id="r2kHeader">
    <div class="h-inner">
      <a href="/" class="brand" aria-label="R2K2 Home">
        <img src="/assets/logo.png" class="logo" alt="R2K2">
        <div class="name">R2K<span class="accent">2</span></div>
      </a>
      <nav class="nav">
        <a href="/">Home</a>
        <a href="/leaderboard/rainbet">Leaderboard</a>
        <a href="/raffle" aria-current="page">Raffle</a>
        <a href="/challenges">Challenges</a>
      </nav>
      <div class="actions">
        <a class="btn alt" href="https://rainbet.com/?r=r2k2" target="_blank" rel="noopener">Join Rainbet</a>
      </div>
    </div>
  </header>

  <main class="wrap">
    <h1 class="hero-title">R2K2 Raffles</h1>
    <p class="hero-sub">
      Weekly & monthly raffles based on wagered amounts under code R2K2.
      Winners are drawn <strong>manually by admin</strong> to avoid any confusion.
    </p>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab-btn active" data-tab="weekly">Weekly</button>
      <button class="tab-btn" data-tab="monthly">Monthly</button>
      <button class="tab-btn admin-pill" id="adminToggle">üîí Admin</button>
      <button class="tab-btn admin-pill admin-only" data-tab="previous" id="prevTab">Previous Winners</button>
    </div>

    <!-- WEEKLY -->
    <section class="panel active" id="panel-weekly">
      <div class="grid">
        <article class="card">
          <div class="prize">$25</div>
          <div class="prize-label">Weekly Raffle ‚Ä¢ 1 Winner</div>

          <div class="pill-row">
            <div class="pill">
              <div class="big">$250</div>
              <div class="cap">Min Wager (Weekly Window)</div>
            </div>
            <div class="pill">
              <div class="big" id="weeklyRemaining">--</div>
              <div class="cap">Time Remaining (ET)</div>
            </div>
          </div>

          <div class="stat">
            <div class="count" id="weeklyParticipants">0</div>
            <div class="cap">Qualified Entrants</div>
          </div>

          <div class="meta-line" style="margin-top:10px;">
            <span>Window:</span>
            <span id="weeklyWindow"><strong>‚Äî</strong></span>
          </div>

          <div class="meta-line">
            <span>Status:</span>
            <span id="weeklyStatus"><strong>Waiting for window to finish</strong></span>
          </div>

          <button class="btn alt" id="weeklyView">üë• View Entrants</button>
          <button class="btn admin-only" id="weeklyDraw">üé¨ Draw Weekly Winner (Admin)</button>
        </article>
      </div>
    </section>

    <!-- MONTHLY -->
    <section class="panel" id="panel-monthly">
      <div class="grid">
        <article class="card">
          <div class="prize">$100</div>
          <div class="prize-label">Monthly Raffle ‚Ä¢ 1 Winner</div>

          <div class="pill-row">
            <div class="pill">
              <div class="big">$5,000</div>
              <div class="cap">Min Wager (30 Day Window)</div>
            </div>
            <div class="pill">
              <div class="big" id="monthlyRemaining">--</div>
              <div class="cap">Time Remaining (ET)</div>
            </div>
          </div>

          <div class="stat">
            <div class="count" id="monthlyParticipants">0</div>
            <div class="cap">Qualified Entrants</div>
          </div>

          <div class="meta-line" style="margin-top:10px;">
            <span>Window:</span>
            <span id="monthlyWindow"><strong>‚Äî</strong></span>
          </div>

          <div class="meta-line">
            <span>Status:</span>
            <span id="monthlyStatus"><strong>Waiting for window to finish</strong></span>
          </div>

          <button class="btn alt" id="monthlyView">üë• View Entrants</button>
          <button class="btn admin-only" id="monthlyDraw">üé¨ Draw Monthly Winner (Admin)</button>
        </article>
      </div>
    </section>

    <!-- PREVIOUS WINNERS (STATIC / HAND-EDITED BY YOU) -->
    <section class="panel" id="panel-previous">
      <div class="grid">
        <article class="card">
          <h3 style="margin-top:0;">Previous Winners (Manual Log)</h3>
          <p style="margin:0 0 8px;font-size:12px;color:var(--muted);">
            This table is <strong>canonical</strong>. Edit this HTML file to add/update winners after each draw.
          </p>
          <table class="wins">
            <thead>
              <tr>
                <th>Date (ET)</th>
                <th>Type</th>
                <th>Winner</th>
                <th>Prize</th>
                <th>Entries</th>
              </tr>
            </thead>
            <tbody id="winsBody">
              <!-- EXAMPLE ROWS for you to edit/remove -->
              <!--
              <tr>
                <td>2025-11-07</td>
                <td>Weekly</td>
                <td>R2KRaph</td>
                <td>$25</td>
                <td>12</td>
              </tr>
              -->
              <tr><td colspan="5" style="color:var(--muted);padding:10px 4px;">No winners logged yet.</td></tr>
            </tbody>
          </table>
        </article>
      </div>
    </section>
  </main>

  <!-- DRAW MODAL -->
  <div class="modal" id="drawModal" aria-hidden="true">
    <div class="sheet">
      <div class="sheet-header">
        <h3 class="sheet-title" id="drawTitle">Drawing‚Ä¶</h3>
        <button class="close-x" id="closeModal">Close</button>
      </div>
      <div class="roller">
        <div class="strip" id="strip"></div>
      </div>
      <div id="winnerLine"></div>
      <div id="entrantList"></div>
      <p style="margin-top:10px;font-size:11px;color:var(--muted);">
        Note: Copy this winner & entrants into your own records or into the "Previous Winners" table above.
      </p>
    </div>
  </div>

  <script>
    /* ========== Basic constants ========== */
    const TZ = "America/New_York"; // ET
    const API_LB = "/api/leaderboard"; // your existing endpoint
    const WEEKLY_MIN = 250;
    const MONTHLY_MIN = 5000;

    // Weekly windows: Friday 00:00:00 ET -> next Friday 00:00:00 ET
    // We'll anchor from 2025-11-07 00:00 ET to align with your "11/7-11/14" note.
    const WEEKLY_ANCHOR_ET = new Date("2025-11-07T05:00:00Z"); // 00:00 ET = 05:00 UTC
    // Monthly: starting 2025-10-30 00:00 ET, 30-day windows
    const MONTHLY_ANCHOR_ET = new Date("2025-10-30T04:00:00Z"); // 00:00 ET = 04:00 UTC
    const DAY_MS = 86400000;

    // Admin token: SHA-256("R2^Access") -> same as before
    const ADMIN_HASH = "70dff427e907ed401784f867d458083753fea924732e7aa80c9e5d678e391643";
    let IS_ADMIN = false;

    /* ========== Helpers ========== */
    const pad2 = n => String(n).padStart(2,"0");
    const fmtUsd = n => n.toLocaleString(undefined,{style:"currency",currency:"USD",maximumFractionDigits:2});
    const escapeHtml = s => String(s).replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
    }[c]));

    function inTZ(date, tz=TZ){
      const parts = new Intl.DateTimeFormat("en-US",{
        timeZone:tz,
        year:"numeric",month:"2-digit",day:"2-digit",
        hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:false
      }).formatToParts(date);
      const get = t => parts.find(p=>p.type===t)?.value;
      return {
        y:+get("year"),m:+get("month"),d:+get("day"),
        hh:+get("hour"),mm:+get("minute"),ss:+get("second")
      };
    }
    function formatDateRange(start,end){
      const s = inTZ(start), e = inTZ(end);
      return `${s.y}-${pad2(s.m)}-${pad2(s.d)} ‚Üí ${e.y}-${pad2(e.m)}-${pad2(e.d)}`;
    }
    function remaining(to){
      const ms = to.getTime() - Date.now();
      if(ms <= 0) return "00d 00:00:00";
      const S = Math.floor(ms/1000);
      const d = Math.floor(S/86400);
      const h = Math.floor((S%86400)/3600);
      const m = Math.floor((S%3600)/60);
      const s = S%60;
      return `${pad2(d)}d ${pad2(h)}:${pad2(m)}:${pad2(s)}`;
    }

    function currentWeeklyWindow(){
      const now = new Date();
      const span = 7 * DAY_MS;
      const k = Math.floor((now - WEEKLY_ANCHOR_ET) / span);
      const start = new Date(WEEKLY_ANCHOR_ET.getTime() + k*span);
      const end = new Date(start.getTime() + span);
      return {start,end};
    }
    function currentMonthlyWindow(){
      const now = new Date();
      const span = 30 * DAY_MS;
      const k = Math.floor((now - MONTHLY_ANCHOR_ET) / span);
      const start = new Date(MONTHLY_ANCHOR_ET.getTime() + k*span);
      const end = new Date(start.getTime() + span);
      return {start,end};
    }

    function isoDateTZ(d, tz = TZ){
      const p = inTZ(d,tz);
      return `${p.y}-${pad2(p.m)}-${pad2(p.d)}`;
    }

    /* ========== Fetch entrants ========== */
    async function fetchEntrants(start,end,minUSD){
      const startISO = isoDateTZ(start);
      const endISO   = isoDateTZ(end);
      const url = `${API_LB}?start_at=${encodeURIComponent(startISO)}&end_at=${encodeURIComponent(endISO)}`;
      const res = await fetch(url,{cache:"no-store"});
      if(!res.ok){
        const txt = await res.text().catch(()=> "");
        throw new Error(`Leaderboard API ${res.status} ‚Äì ${txt.slice(0,200)}`);
      }
      const json = await res.json();
      const raw = Array.isArray(json) ? json : (json.affiliates || []);
      const byUser = new Map();
      for(const a of raw){
        const name = (a.username||"").trim();
        const amt = Number(a.wagered_amount ?? a.wagered ?? 0);
        if(!name || !Number.isFinite(amt)) continue;
        byUser.set(name,(byUser.get(name)||0)+amt);
      }
      const entrants = [];
      byUser.forEach((sum,name)=>{
        if(sum >= minUSD) entrants.push({name,wagered:sum});
      });
      entrants.sort((a,b)=>b.wagered - a.wagered);
      return entrants;
    }

    /* ========== RNG & spinner ========== */
    function securePick(n){
      if(n<=1) return 0;
      const max = Math.floor(0x100000000/n)*n;
      const buf = new Uint32Array(1);
      while(true){
        crypto.getRandomValues(buf);
        const x = buf[0];
        if(x < max) return x % n;
      }
    }

    const modal = document.getElementById("drawModal");
    const strip = document.getElementById("strip");
    const winnerLine = document.getElementById("winnerLine");
    const entrantList = document.getElementById("entrantList");
    const drawTitle = document.getElementById("drawTitle");
    const closeModalBtn = document.getElementById("closeModal");

    closeModalBtn.addEventListener("click", hideModal);
    function showModal(){
      modal.classList.add("show");
      modal.setAttribute("aria-hidden","false");
    }
    function hideModal(){
      modal.classList.remove("show");
      modal.setAttribute("aria-hidden","true");
      strip.style.transition = "none";
      strip.style.transform = "translateY(0)";
    }

    function renderEntrantList(entrants){
      if(!entrants.length){
        entrantList.innerHTML = `<div style="padding:8px 10px;color:#a6c9ef;font-size:13px;">No qualified entrants for this window.</div>`;
        return;
      }
      entrantList.innerHTML = entrants.map(e=>`
        <div class="row">
          <span>${escapeHtml(e.name)}</span>
          <span style="color:#a6c9ef;">${fmtUsd(e.wagered)}</span>
        </div>
      `).join("");
    }

    let SPIN_LOCK = false;
    async function spinAndPick(entrants){
      if(SPIN_LOCK) return null;
      SPIN_LOCK = true;
      strip.innerHTML = "";
      winnerLine.textContent = "";

      if(!entrants.length){
        winnerLine.textContent = "No qualified entrants.";
        SPIN_LOCK = false;
        return null;
      }

      const idx = securePick(entrants.length);
      const winner = entrants[idx].name;

      const names = entrants.map(e=>e.name);
      const cycles = Math.max(40,names.length*4);
      const seq = [];
      for(let i=0;i<cycles;i++) seq.push(names[i % names.length]);
      seq.push(winner,winner,winner);

      strip.innerHTML = seq.map(n=>`<div class="name">${escapeHtml(n)}</div>`).join("");
      const rowH = 34;
      const target = -(seq.length-1)*rowH;

      strip.style.transition = "none";
      strip.style.transform = "translateY(0)";
      void strip.offsetHeight;
      strip.style.transition = "transform 2.2s cubic-bezier(.2,.7,0,1)";
      strip.style.transform = `translateY(${target}px)`;

      await new Promise(resolve => strip.addEventListener("transitionend", resolve,{once:true}));
      winnerLine.textContent = `üèÜ Winner: ${winner}`;
      SPIN_LOCK = false;
      return winner;
    }

    async function runDraw(kindLabel, window, minUSD){
      try{
        drawTitle.textContent = `${kindLabel} Draw ‚Ä¢ ${formatDateRange(window.start,window.end)}`;
        winnerLine.textContent = "";
        strip.innerHTML = "";
        entrantList.innerHTML = `<div style="padding:8px 10px;font-size:13px;color:#a6c9ef;">Loading entrants‚Ä¶</div>`;
        showModal();

        const entrants = await fetchEntrants(window.start,window.end,minUSD);
        renderEntrantList(entrants);
        const winnerName = await spinAndPick(entrants);

        if(!winnerName){
          return null;
        }

        console.log("Winner:",kindLabel,winnerName,"entries:",entrants.length);
        return {winner:winnerName, entrants};
      }catch(err){
        console.error(err);
        alert("Draw failed: "+(err.message || err));
        return null;
      }
    }

    /* ========== Admin unlock ========== */
    async function sha256Hex(s){
      const d = new TextEncoder().encode(s);
      const h = await crypto.subtle.digest("SHA-256",d);
      return [...new Uint8Array(h)].map(b=>b.toString(16).padStart(2,"0")).join("");
    }

    const adminToggle = document.getElementById("adminToggle");
    const prevTabBtn = document.getElementById("prevTab");

    adminToggle.addEventListener("click", async ()=>{
      const token = prompt("Enter admin token:");
      if(!token) return;
      const hex = await sha256Hex(token);
      if(hex === ADMIN_HASH){
        IS_ADMIN = true;
        alert("Admin unlocked.");
        document.querySelectorAll(".admin-only").forEach(el=>{
          el.style.display = "";
        });
        adminToggle.textContent = "‚úÖ Admin";
      }else{
        alert("Invalid token.");
      }
    });

    /* ========== Tabs ========== */
    document.querySelectorAll(".tab-btn[data-tab]").forEach(btn=>{
      btn.addEventListener("click",()=>{
        const tab = btn.dataset.tab;
        document.querySelectorAll(".tab-btn[data-tab]").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        document.querySelectorAll(".panel").forEach(p=>p.classList.remove("active"));
        document.getElementById("panel-"+tab).classList.add("active");
      });
    });

    /* ========== UI wiring ========== */
    const weeklyRemainingEl    = document.getElementById("weeklyRemaining");
    const weeklyWindowEl       = document.getElementById("weeklyWindow");
    const weeklyStatusEl       = document.getElementById("weeklyStatus");
    const weeklyParticipantsEl = document.getElementById("weeklyParticipants");
    const weeklyViewBtn        = document.getElementById("weeklyView");
    const weeklyDrawBtn        = document.getElementById("weeklyDraw");

    const monthlyRemainingEl    = document.getElementById("monthlyRemaining");
    const monthlyWindowEl       = document.getElementById("monthlyWindow");
    const monthlyStatusEl       = document.getElementById("monthlyStatus");
    const monthlyParticipantsEl = document.getElementById("monthlyParticipants");
    const monthlyViewBtn        = document.getElementById("monthlyView");
    const monthlyDrawBtn        = document.getElementById("monthlyDraw");

    async function refreshWeekly(){
      const win = currentWeeklyWindow();
      weeklyWindowEl.innerHTML = `<strong>${formatDateRange(win.start,win.end)}</strong>`;
      weeklyRemainingEl.textContent = remaining(win.end);
      const msLeft = win.end.getTime() - Date.now();
      weeklyStatusEl.innerHTML = msLeft > 0
        ? "<strong>Window active ‚Äì draw after it ends</strong>"
        : "<strong>Window ended ‚Äì admin can draw winner</strong>";

      try{
        const entrants = await fetchEntrants(win.start,win.end,WEEKLY_MIN);
        weeklyParticipantsEl.textContent = entrants.length;
        weeklyViewBtn.onclick = ()=>{
          drawTitle.textContent = `Weekly Entrants ‚Ä¢ ${formatDateRange(win.start,win.end)}`;
          renderEntrantList(entrants);
          winnerLine.textContent = "";
          strip.innerHTML = "";
          showModal();
        };
        weeklyDrawBtn.onclick = async ()=>{
          if(!IS_ADMIN){
            alert("Admin only. Unlock admin first.");
            return;
          }
          if(msLeft > 0 && !confirm("Window has not ended yet. Draw anyway?")){
            return;
          }
          await runDraw("Weekly",win,WEEKLY_MIN);
        };
      }catch(err){
        console.error(err);
        weeklyParticipantsEl.textContent = "‚Äî";
        weeklyViewBtn.onclick = ()=>{
          drawTitle.textContent = "Weekly Entrants";
          entrantList.innerHTML = `<div style="padding:8px 10px;font-size:13px;color:#ffaaaa;">Failed to load entrants.</div>`;
          winnerLine.textContent = "";
          strip.innerHTML = "";
          showModal();
        };
      }
    }

    async function refreshMonthly(){
      const win = currentMonthlyWindow();
      monthlyWindowEl.innerHTML = `<strong>${formatDateRange(win.start,win.end)}</strong>`;
      monthlyRemainingEl.textContent = remaining(win.end);
      const msLeft = win.end.getTime() - Date.now();
      monthlyStatusEl.innerHTML = msLeft > 0
        ? "<strong>Window active ‚Äì draw after it ends</strong>"
        : "<strong>Window ended ‚Äì admin can draw winner</strong>";

      try{
        const entrants = await fetchEntrants(win.start,win.end,MONTHLY_MIN);
        monthlyParticipantsEl.textContent = entrants.length;
        monthlyViewBtn.onclick = ()=>{
          drawTitle.textContent = `Monthly Entrants ‚Ä¢ ${formatDateRange(win.start,win.end)}`;
          renderEntrantList(entrants);
          winnerLine.textContent = "";
          strip.innerHTML = "";
          showModal();
        };
        monthlyDrawBtn.onclick = async ()=>{
          if(!IS_ADMIN){
            alert("Admin only. Unlock admin first.");
            return;
          }
          if(msLeft > 0 && !confirm("Window has not ended yet. Draw anyway?")){
            return;
          }
          await runDraw("Monthly",win,MONTHLY_MIN);
        };
      }catch(err){
        console.error(err);
        monthlyParticipantsEl.textContent = "‚Äî";
        monthlyViewBtn.onclick = ()=>{
          drawTitle.textContent = "Monthly Entrants";
          entrantList.innerHTML = `<div style="padding:8px 10px;font-size:13px;color:#ffaaaa;">Failed to load entrants.</div>`;
          winnerLine.textContent = "";
          strip.innerHTML = "";
          showModal();
        };
      }
    }

    // live countdowns
    function tickCountdowns(){
      const w = currentWeeklyWindow();
      const m = currentMonthlyWindow();
      weeklyRemainingEl.textContent = remaining(w.end);
      monthlyRemainingEl.textContent = remaining(m.end);
    }

    // boot
    refreshWeekly();
    refreshMonthly();
    setInterval(tickCountdowns,1000);
  </script>
</body>
</html>